(function(T,L){typeof exports=="object"&&typeof module<"u"?L(exports):typeof define=="function"&&define.amd?define(["exports"],L):(T=typeof globalThis<"u"?globalThis:T||self,L(T.EngineZenith={}))})(this,function(T){"use strict";var _e=Object.defineProperty;var ke=(T,L,nt)=>L in T?_e(T,L,{enumerable:!0,configurable:!0,writable:!0,value:nt}):T[L]=nt;var x=(T,L,nt)=>ke(T,typeof L!="symbol"?L+"":L,nt);const L=0x0101010101010101n,nt=0x8080808080808080n,rt=0xffffffffffffffffn,dt=rt^L,wt=rt^nt;function Mt(f){return(f&wt)<<1n}function vt(f){return(f&dt)>>1n}function St(f){return f<<8n}function bt(f){return f>>8n}function _t(f){return(f&wt)<<9n}function kt(f){return(f&dt)<<7n}function Ct(f){return(f&wt)>>7n}function Pt(f){return(f&dt)>>9n}const te=[Mt,vt,St,bt,_t,kt,Ct,Pt];function Z(f){let t=0,e=BigInt(f);for(;e;)t++,e&=e-1n;return t}function xt(f){let t=0n,e=BigInt(f);for(;e>1n;)e>>=1n,t++;return Number(t)}function Dt(f,t){return(7-f)*8+t}function ee(f){if(f<0||f>63)throw new Error("Invalid bit index: "+f);const e=7-(f/8|0),n=f%8;return[e,n]}function Bt(f,t){return 1n<<BigInt(Dt(f,t))}function ft(f){const t=[];let e=BigInt(f);for(;e;){const n=e&-e,r=xt(n),[s,i]=ee(r);t.push({row:s,col:i}),e^=n}return t}function Ft(f){return f&&typeof f.length=="number"&&typeof f.subarray=="function"}function ne(f){const t=new Uint8Array(64);for(let e=0;e<8;e++)for(let n=0;n<8;n++){const r=f[e][n];t[e*8+n]=r==="black"?1:r==="white"?2:0}return t}function re(f){let t=0n,e=0n;for(let n=0;n<64;n++){const r=f[n]|0;if(r===0)continue;const s=n/8|0,i=n%8,o=Dt(s,i),c=1n<<BigInt(o);r===1?t|=c:r===2&&(e|=c)}return{bp:t,wp:e}}function N(f){let t;if(Ft(f)?t=f:Array.isArray(f)&&Array.isArray(f[0])?t=ne(f):Array.isArray(f)?t=Uint8Array.from(f):f&&f.cells&&Ft(f.cells)?t=f.cells:t=new Uint8Array(64),t._bp===void 0||t._wp===void 0){const{bp:e,wp:n}=re(t);t._bp=e,t._wp=n}return t}function se(f,t,e){let n=e(f)&t;return n|=e(n)&t,n|=e(n)&t,n|=e(n)&t,n|=e(n)&t,n|=e(n)&t,e(n)}function st(f,t){const e=N(t),n=f===1?e._bp:e._wp,r=f===1?e._wp:e._bp,s=~(n|r)&rt;let i=0n;for(const o of te)i|=se(n,r,o);return i&s}function ht(f){return f==="black"?1:2}function ie(f,t){const e=ht(f),n=st(e,t);return ft(n)}function Tt(f,t,e){let n=0n,r,s;for(r=Mt(e),s=0n;r&&r&t;)s|=r,r=Mt(r);for(r&f&&(n|=s),r=vt(e),s=0n;r&&r&t;)s|=r,r=vt(r);for(r&f&&(n|=s),r=St(e),s=0n;r&&r&t;)s|=r,r=St(r);for(r&f&&(n|=s),r=bt(e),s=0n;r&&r&t;)s|=r,r=bt(r);for(r&f&&(n|=s),r=_t(e),s=0n;r&&r&t;)s|=r,r=_t(r);for(r&f&&(n|=s),r=kt(e),s=0n;r&&r&t;)s|=r,r=kt(r);for(r&f&&(n|=s),r=Ct(e),s=0n;r&&r&t;)s|=r,r=Ct(r);for(r&f&&(n|=s),r=Pt(e),s=0n;r&&r&t;)s|=r,r=Pt(r);return r&f&&(n|=s),n}function Rt(f,t,e,n){const r=ht(e),s=N(n),i=Bt(f,t),o=r===1?s._bp:s._wp,c=r===1?s._wp:s._bp;return(i&(o|c))!==0n?!1:Tt(o,c,i)!==0n}function lt(f,t,e,n){const r=ht(n),s=N(f),i=Bt(t,e),o=r===1?s._bp:s._wp,c=r===1?s._wp:s._bp;if((i&(o|c))!==0n)return;const l=Tt(o,c,i);if(!l)return;const a=s._bp,u=s._wp,h=o|i|l,y=c&~l;r===1?(s._bp=h,s._wp=y):(s._wp=h,s._bp=y);let m=l|i;for(;m;){const d=m&-m,E=xt(d);s[E]=r,m^=d}return{__native:!0,side:r,row:t,col:e,moveMask:i,flips:l,prevBP:a,prevWP:u}}function gt(f,t,e){const n=N(f);if(!t||!t.__native)return;n._bp=t.prevBP,n._wp=t.prevWP;let s=t.flips|t.moveMask;for(;s;){const i=s&-s,o=xt(i),c=1n<<BigInt(o),l=(t.prevBP&c)!==0n,a=(t.prevWP&c)!==0n;n[o]=l?1:a?2:0,s^=i}}function Ht(f){const t=N(f),e=t._bp|t._wp;return Z(~e&rt)}function It(f,t){const e=ht(t),n=N(f),r=0x100000001b3n,s=0x100000001b5n;let i=0xcbf29ce484222325n;return i^=n._bp*r&rt,i*=s,i^=n._wp*s&rt,i*=r,i^=BigInt(e&3),i*=0x100000001b7n,Number(i&0xffffffffffffffffn)}function Y(f){const t=new Uint8Array(64);for(let e=0;e<8;e++)for(let n=0;n<8;n++){const r=f[e][n],s=e*8+n;r==="black"?t[s]=1:r==="white"?t[s]=2:t[s]=0}return t}function Et(f){const t=[];for(let e=0;e<8;e++){const n=[];for(let r=0;r<8;r++){const s=e*8+r,i=f[s];i===1?n.push("black"):i===2?n.push("white"):n.push(null)}t.push(n)}return t}function At(f=crypto.randomUUID()){const t=Array.from({length:8},()=>new Array(8).fill(null));t[3][3]="white",t[3][4]="black",t[4][3]="black",t[4][4]="white";const e=J(t,"black");return{id:f,board:t,currentPlayer:"black",validMoves:e,score:{black:2,white:2},status:"playing",moveHistory:[],canUndo:!1,canRedo:!1}}function J(f,t){const e=N(Y(f));return ie(t,e)}function Nt(f,t,e){const n=N(Y(f));return Rt(t.row,t.col,e,n)}function pt(f,t){if(f.status!=="playing")return{success:!1,reason:"game_finished",message:"Game is not in playing state"};if(!(f.currentPlayer==="black"||f.currentPlayer==="white"))return{success:!1,reason:"not_your_turn",message:"Invalid current player"};const e=N(Y(f.board));if(!Rt(t.row,t.col,f.currentPlayer,e))return e[t.row*8+t.col]!==0?{success:!1,reason:"occupied",message:"Position is already occupied"}:{success:!1,reason:"no_captures",message:"Move would not capture any pieces"};if(!lt(e,t.row,t.col,f.currentPlayer))return{success:!1,reason:"invalid_position",message:"Failed to apply move"};const r=Et(e),s=[];for(let M=0;M<8;M++)for(let m=0;m<8;m++)f.board[M][m]!==r[M][m]&&!(M===t.row&&m===t.col)&&s.push({row:M,col:m});const i={row:t.row,col:t.col,player:f.currentPlayer,capturedCells:s,timestamp:Date.now()},o=mt(r),c=f.currentPlayer==="black"?"white":"black",l=J(r,c);let a=c,u=l,h="playing";if(l.length===0){const M=J(r,f.currentPlayer);M.length===0?(h="finished",u=[]):(a=f.currentPlayer,u=M)}const y={...f,board:r,currentPlayer:a,validMoves:u,score:o,status:h,moveHistory:[...f.moveHistory,i],canUndo:!0,canRedo:!1};return{success:!0,move:i,newGameCore:y,capturedCells:s}}function mt(f){let t=0,e=0;for(let n=0;n<8;n++)for(let r=0;r<8;r++){const s=f[n][r];s==="black"?t++:s==="white"&&e++}return{black:t,white:e}}function zt(f){if(f.status==="finished")return!0;if(J(f.board,f.currentPlayer).length>0)return!1;const e=f.currentPlayer==="black"?"white":"black";return J(f.board,e).length===0}function qt(f){if(!zt(f))return null;const t=mt(f.board);let e;return t.black>t.white?e="black":t.white>t.black?e="white":e="draw",{winner:e,score:t,endReason:"normal",duration:0,totalMoves:f.moveHistory.length}}function Lt(f){const t=N(Y(f.board));return It(t,f.currentPlayer)}function oe(f,t){return J(f,t).length}function ce(f){const t=N(Y(f));return Ht(t)}class le{constructor(t={}){x(this,"_currentGame");x(this,"_gameHistory",[]);x(this,"_redoStack",[]);x(this,"_listeners",[]);x(this,"_config");this._config={maxHistorySize:t.maxHistorySize||100,enableUndo:t.enableUndo??!0,enableRedo:t.enableRedo??!0,autoSave:t.autoSave??!1},this._currentGame=At(),this._gameHistory.push({...this._currentGame}),this.emit({type:"game_started",gameCore:this._currentGame})}get currentGame(){return this._currentGame}get currentPlayer(){return this._currentGame.currentPlayer}get validMoves(){return this._currentGame.validMoves}get score(){return this._currentGame.score}get isGameOver(){return zt(this._currentGame)}get gameResult(){return qt(this._currentGame)}get canUndo(){return this._config.enableUndo&&this._gameHistory.length>1}get canRedo(){return this._config.enableRedo&&this._redoStack.length>0}makeMove(t){if(this.isGameOver)return{success:!1,reason:"game_finished",message:"Game is already finished"};const e=pt(this._currentGame,t);if(e.success){if(this._currentGame=e.newGameCore,this._redoStack=[],this._gameHistory.push({...this._currentGame}),this._gameHistory.length>this._config.maxHistorySize&&this._gameHistory.shift(),this.emit({type:"move_made",move:e.move,gameCore:this._currentGame}),this.isGameOver){const n=this.gameResult;n&&this.emit({type:"game_over",result:n})}else this.emit({type:"turn_changed",player:this._currentGame.currentPlayer});this._config.autoSave&&this.saveToStorage()}return e}undo(){if(!this.canUndo)return!1;this._redoStack.push({...this._currentGame}),this._gameHistory.pop();const t=this._gameHistory[this._gameHistory.length-1];return this._currentGame={...t},this.emit({type:"move_undone",gameCore:this._currentGame}),this.emit({type:"turn_changed",player:this._currentGame.currentPlayer}),!0}redo(){if(!this.canRedo)return!1;const t=this._redoStack.pop();return this._currentGame=t,this._gameHistory.push({...this._currentGame}),this.emit({type:"move_redone",gameCore:this._currentGame}),this.emit({type:"turn_changed",player:this._currentGame.currentPlayer}),!0}reset(){this._currentGame=At(),this._gameHistory=[{...this._currentGame}],this._redoStack=[],this.emit({type:"game_reset",gameCore:this._currentGame}),this.emit({type:"game_started",gameCore:this._currentGame})}isValidMove(t){return Nt(this._currentGame.board,t,this._currentGame.currentPlayer)}getValidMoves(){return J(this._currentGame.board,this._currentGame.currentPlayer)}setGameStatus(t){this._currentGame.status!==t&&(this._currentGame={...this._currentGame,status:t})}getPositionHash(){return Lt(this._currentGame)}getMoveHistory(){return this._currentGame.moveHistory}getGameStats(){return{totalMoves:this._currentGame.moveHistory.length,score:this._currentGame.score,gameId:this._currentGame.id,currentPlayer:this._currentGame.currentPlayer,status:this._currentGame.status,canUndo:this.canUndo,canRedo:this.canRedo,validMovesCount:this._currentGame.validMoves.length,historySize:this._gameHistory.length}}addEventListener(t){this._listeners.push(t)}removeEventListener(t){const e=this._listeners.indexOf(t);e!==-1&&this._listeners.splice(e,1)}removeAllEventListeners(){this._listeners=[]}emit(t){this._listeners.forEach(e=>{try{e(t)}catch(n){console.error("Error in game event listener:",n)}})}saveToStorage(t="othello-game-state"){try{const e={currentGame:this._currentGame,gameHistory:this._gameHistory,redoStack:this._redoStack,timestamp:Date.now()};localStorage.setItem(t,JSON.stringify(e))}catch(e){console.error("Failed to save game state:",e)}}loadFromStorage(t="othello-game-state"){try{const e=localStorage.getItem(t);if(!e)return!1;const n=JSON.parse(e);return this._currentGame=n.currentGame,this._gameHistory=n.gameHistory||[],this._redoStack=n.redoStack||[],this.emit({type:"game_started",gameCore:this._currentGame}),!0}catch(e){return console.error("Failed to load game state:",e),!1}}exportGame(){const t=this._currentGame.moveHistory.map((r,s)=>{const i=Math.floor(s/2)+1,o=r.player==="black"?"B":"W",c=`${String.fromCharCode(97+r.col)}${r.row+1}`;return`${i}.${o} ${c}`}),e=this.gameResult,n=e?e.winner==="draw"?"1/2-1/2":e.winner==="black"?"1-0":"0-1":"*";return[`[Game "${this._currentGame.id}"]`,'[Black "Player"]','[White "Player"]',`[Result "${n}"]`,`[Score "${this._currentGame.score.black}-${this._currentGame.score.white}"]`,"",t.join(" ")+(n!=="*"?` ${n}`:"")].join(`
`)}createSimulation(){return JSON.parse(JSON.stringify(this._currentGame))}simulateMoves(t){let e=this.createSimulation();for(const n of t){const r=pt(e,n);if(r.success)e=r.newGameCore;else break}return e}getGameStateAtMove(t){return t<0||t>=this._gameHistory.length?null:{...this._gameHistory[t]}}dispose(){this.removeAllEventListeners(),this._gameHistory=[],this._redoStack=[]}}const Ot=64;function jt(f,t="black"){const{black:e,white:n}=mt(f);return t==="black"?e-n:n-e}function $t(f){if(f===void 0||Number.isNaN(f))return 0;const t=Math.tanh(f/120),e=Math.round(t*Ot);return Math.max(-Ot,Math.min(Ot,e))}function ae(f,t,e="black"){return{perspective:e,stoneDiff:jt(f,e),normalizedEval:$t(t)}}class ue{constructor(){x(this,"gameCore");x(this,"gameStateManager");x(this,"bitboard",null);this.gameCore=At(),this.gameStateManager=new le}getValidMoves(t,e){return J(t,e)}isValidMove(t,e,n){return Nt(t,e,n)}simulateMove(t,e,n){try{const r=N(Y(t));return lt(r,e.row,e.col,n)?Et(r):null}catch(r){return console.warn("SimulateMove error:",r),null}}applyMove(t,e){return pt(t,e)}calculateScore(t){return mt(t)}getEmptySquares(t){return ce(t)}getMobility(t,e){return oe(t,e)}isGameOver(t){return zt(t)}getGameResult(t){return qt(t)}getPositionHash(t){return Lt(t)}boardToBitBoard(t){return N(Y(t))}bitBoardToBoard(t){return Et(t)}flipPiecesBitboard(t,e,n,r){return lt(t,e,n,r)}undoMoveBitboard(t,e){gt(t,e)}getStoneDifference(t,e="black"){return jt(t,e)}mapEvaluationToStoneScale(t){return $t(t)}summarizeEvaluation(t,e,n="black"){return ae(t,e,n)}getGameStateManager(){return this.gameStateManager}getCurrentGameCore(){return this.gameCore}updateGameCore(t){this.gameCore=t}getOpponent(t){return t==="black"?"white":"black"}copyBoard(t){return t.map(e=>[...e])}analyzeGamePhase(t){const e=this.getEmptySquares(t);return e>50?"opening":e>20?"midgame":"endgame"}difficultyToSkill(t){return{easy:25,medium:50,hard:75,expert:90,master:100}[t]||50}skillToDifficulty(t){return t<=30?"easy":t<=60?"medium":t<=80?"hard":t<=95?"expert":"master"}initialize(){}cleanup(){}updateConfig(t){}getFallbackResponse(t){const e=this.getValidMoves(this.gameCore.board,this.gameCore.currentPlayer);return{bestMove:e.length>0?e[Math.floor(Math.random()*e.length)]:void 0,evaluation:0,depth:0,nodes:1,timeUsed:Date.now()-t}}validateRequest(t){if(!t.gameCore)throw new Error("GameCore is required");if(!t.gameCore.board)throw new Error("Board is required");if(!t.gameCore.currentPlayer)throw new Error("Current player is required")}}const it=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],Ut=[[120,-25,20,8,8,20,-25,120],[-25,-45,-8,-6,-6,-8,-45,-25],[20,-8,15,4,4,15,-8,20],[8,-6,4,3,3,4,-6,8],[8,-6,4,3,3,4,-6,8],[20,-8,15,4,4,15,-8,20],[-25,-45,-8,-6,-6,-8,-45,-25],[120,-25,20,8,8,20,-25,120]];class fe{constructor(){x(this,"STRATEGIC_POLARITY_GUARD",!0);x(this,"weights");x(this,"phaseWeights");this.weights=this.getDefaultWeights(),this.phaseWeights=this.initializePhaseWeights()}evaluateBoard(t,e,n,r){var D;if(!t||!e||!n)return this.getDefaultEvaluationResult();const s=this.getOpponent(e),i=this.scanBoard(t,e),o=this.getBlendedWeights(t)??(this.phaseWeights.get(n)||this.weights),c=(i.myCount-i.opCount)*o.material,l=(i.posMy-i.posOp)*o.position,a=this.evaluateMobilityComplexFromCache(i)*o.mobility,u=this.normalizeDiff(i.frontierMy,i.frontierOp,!0)*o.frontier,h=this.countStableDiscs(t,e),y=this.countStableDiscs(t,s),M=this.normalizeDiff(h,y)*o.stability,m=(i.myCorners-i.opCorners)*95+this.evaluateCornerPotential(t,e,s),b=this.clamp(m,-400,400)*o.corner,d=(i.myEdgeNoCorner-i.opEdgeNoCorner)*5+this.evaluateEdgeStructure(t,e,s),E=this.clamp(d,-140,140)*o.edge,C=this.evaluateCenter(t,e,s)*o.center,_=this.evaluateSafety(t,e)*o.safety;let v=this.evaluateStrategic(r)*o.strategic;if(this.STRATEGIC_POLARITY_GUARD){const H=Math.abs(v)>50,P=a>=0?1:-1,O=v>=0?1:-1;if(H&&P!==O){v*=.7;const W=c>=0?1:-1,F=b>=0?1:-1;O!==W&&O!==F&&(v*=.5)}}const S=i.emptyCount,G=S<=12?1:S<=20?.8:S<=28?.5:0,z=S<=44&&S>=16?.35:.1,R=S>=28?.55:.2,A=this.parityHeuristic(t,e)*G,V=this.badMovePressure(t,e)*z,$=this.internalDiscRatio(t,e)*R,B=c+l+a+u+M+b+E+C+_+v+A+V+$,g=Math.max(-200,Math.min(200,B));typeof process<"u"&&((D=process.env)==null?void 0:D.NODE_ENV)==="development"&&Math.abs(g)>150&&console.warn("Zenith: 극단적인 평가 점수 감지",{totalScore:B,finalScore:g,materialScore:c,mobilityScore:a,strategicScore:v,cornerScore:b,safetyScore:_,player:e,empties:i.emptyCount});const p=this.calculateConfidenceFromCache(i,t,e,a),w=this.calculateDepthByEmpties(S),k=this.calculateNodesByEmpties(S,i.legalMy);return{score:g,depth:w,nodes:k,confidence:p,pv:this.calculatePV(t,e)}}scanBoard(t,e){const n=this.getOpponent(e);let r=0,s=0,i=0,o=0,c=0,l=0,a=0,u=0,h=0,y=0,M=0;const m=new Set,b=new Set,d=(v,S)=>(v===0||v===7)&&(S===0||S===7),E=(v,S)=>(v===0||v===7||S===0||S===7)&&!d(v,S);for(let v=0;v<8;v++)for(let S=0;S<8;S++){const G=t[v][S];if(G===e){r++,o+=Ut[v][S],d(v,S)?l++:E(v,S)&&u++,this.adjacentEmpty(t,v,S)&&y++;for(const[z,R]of it){const A=v+z,V=S+R;A>=0&&A<8&&V>=0&&V<8&&t[A][V]===null&&b.add(A+","+V)}}else if(G===n){s++,c+=Ut[v][S],d(v,S)?a++:E(v,S)&&h++,this.adjacentEmpty(t,v,S)&&M++;for(const[z,R]of it){const A=v+z,V=S+R;A>=0&&A<8&&V>=0&&V<8&&t[A][V]===null&&m.add(A+","+V)}}else i++}let C=0,_=0;for(let v=0;v<8;v++)for(let S=0;S<8;S++)t[v][S]===null&&(this.isValidMove(t,{row:v,col:S},e)&&C++,this.isValidMove(t,{row:v,col:S},n)&&_++);return{myCount:r,opCount:s,emptyCount:i,posMy:o,posOp:c,myCorners:l,opCorners:a,myEdgeNoCorner:u,opEdgeNoCorner:h,frontierMy:y,frontierOp:M,potMy:m.size,potOp:b.size,legalMy:C,legalOp:_}}adjacentEmpty(t,e,n){for(const[r,s]of it){const i=e+r,o=n+s;if(i>=0&&i<8&&o>=0&&o<8&&t[i][o]===null)return!0}return!1}evaluateMobilityComplexFromCache(t){const e=this.normalizeDiff(t.legalMy,t.legalOp),n=this.normalizeDiff(t.potMy,t.potOp),r=t.emptyCount;let s;r>=44?s=.35:r>=32?s=.5:r>=20?s=.68:r>=12?s=.8:s=.9;const i=e*s+n*(1-s);return this.clamp(i,-100,100)}normalizeDiff(t,e,n=!1){const r=t+e;if(!r)return 0;const s=(t-e)/r*100;return n?-s:s}evaluateCenter(t,e,n){const s=this.countEmptySquares(t)>35,i=[[3,3],[3,4],[4,3],[4,4]],o=[[2,2],[2,3],[2,4],[2,5],[3,2],[3,5],[4,2],[4,5],[5,2],[5,3],[5,4],[5,5]];let c=0;for(const[a,u]of i)t[a][u]===e?c+=s?25:20:t[a][u]===n&&(c-=s?25:20);for(const[a,u]of o)t[a][u]===e?c+=s?12:8:t[a][u]===n&&(c-=s?12:8);const l=i.filter(([a,u])=>t[a][u]===e).length;return l===4?c+=s?30:20:l>=3&&(c+=s?15:10),c}evaluateSafety(t,e){let n=0;const r=this.getOpponent(e),i=this.countEmptySquares(t)>35,o=[[1,1,0,0],[1,6,0,7],[6,1,7,0],[6,6,7,7]];for(const[u,h,y,M]of o){if(t[y][M]!==null)continue;const m=this.opensCornerNext(t,[y,M],e),b=this.opensCornerNext(t,[y,M],r);i?(t[u][h]===e&&(n-=b?120:80),t[u][h]===r&&(n+=m?100:60)):(t[u][h]===e&&(n-=b?60:35),t[u][h]===r&&(n+=m?45:25))}const c=[{corner:[0,0],cells:[[0,1],[1,0]]},{corner:[0,7],cells:[[0,6],[1,7]]},{corner:[7,0],cells:[[6,0],[7,1]]},{corner:[7,7],cells:[[6,7],[7,6]]}];for(const u of c){const[h,y]=u.corner;if(t[h][y]!==null)continue;const M=this.opensCornerNext(t,[h,y],e),m=this.opensCornerNext(t,[h,y],r);for(const[b,d]of u.cells)i?t[b][d]===e?n-=m?90:60:t[b][d]===r&&(n+=M?75:45):t[b][d]===e?n-=m?45:25:t[b][d]===r&&(n+=M?35:18)}const l=(u,h)=>t[u][h]===null,a=(u,h)=>!!(u===0&&(h<=1&&l(0,0)||h>=6&&l(0,7))||u===7&&(h<=1&&l(7,0)||h>=6&&l(7,7))||h===0&&(u<=1&&l(0,0)||u>=6&&l(7,0))||h===7&&(u<=1&&l(0,7)||u>=6&&l(7,7)));for(let u=0;u<8;u++)for(let h=0;h<8;h++)(u===0||u===7||h===0||h===7)&&t[u][h]===e&&a(u,h)&&(n-=6);return n}opensCornerNext(t,e,n){const[r,s]=e;if(t[r][s]!==null)return!1;const i=this.getOpponent(n);for(const[o,c]of it){let l=r+o,a=s+c,u=!1;for(;l>=0&&l<8&&a>=0&&a<8;){const h=t[l][a];if(h===i){u=!0,l+=o,a+=c;continue}if(h===n&&u)return!0;break}}return!1}evaluateStrategic(t){return t?.3*(t.mobility??0)+.2*(t.frontier??0)+.2*(t.stability??0)+.15*(t.cornerControl??0)+.1*(t.edgeControl??0)+.05*(t.centerControl??0):0}isValidMove(t,e,n){const{row:r,col:s}=e;if(r<0||r>=8||s<0||s>=8||t[r][s]!==null)return!1;const i=this.getOpponent(n);for(const[o,c]of it){let l=r+o,a=s+c,u=!1;for(;l>=0&&l<8&&a>=0&&a<8;){const h=t[l][a];if(h===i){u=!0,l+=o,a+=c;continue}if(h===n&&u)return!0;break}}return!1}listValidMoves(t,e){const n=[];for(let r=0;r<8;r++)for(let s=0;s<8;s++)this.isValidMove(t,{row:r,col:s},e)&&n.push({row:r,col:s});return n}isX(t){const{row:e,col:n}=t;return(e===1||e===6)&&(n===1||n===6)}isC(t){const{row:e,col:n}=t;return new Set(["0,1","1,0","0,6","1,7","6,0","7,1","6,7","7,6"]).has(`${e},${n}`)}countStableDiscs(t,e){const n=Array.from({length:8},()=>Array(8).fill(!1)),r=[[0,0],[0,7],[7,0],[7,7]];for(const[c,l]of r)t[c][l]===e&&(n[c][l]=!0);let s=!0,i=0;for(;s&&i++<3;){s=!1;for(let c=0;c<8;c++)for(let l=0;l<8;l++)t[c][l]!==e||n[c][l]||this.isDiscStable(t,c,l,e,n)&&(n[c][l]=!0,s=!0)}let o=0;for(let c=0;c<8;c++)for(let l=0;l<8;l++)n[c][l]&&o++;return o}isDiscStable(t,e,n,r,s){const i=[[[0,1],[0,-1]],[[1,0],[-1,0]],[[1,1],[-1,-1]],[[1,-1],[-1,1]]];for(const[o,c]of i){const l=this.directionSecure(t,e,n,r,s,o[0],o[1]),a=this.directionSecure(t,e,n,r,s,c[0],c[1]);if(!(l&&a))return!1}return!0}directionSecure(t,e,n,r,s,i,o){let c=e+i,l=n+o;for(;c>=0&&c<8&&l>=0&&l<8;){if(t[c][l]===r){if(s[c][l])return!0;c+=i,l+=o;continue}return!1}return!0}parityHeuristic(t,e){const n=Array.from({length:8},()=>Array(8).fill(!1)),r=[-1,1,0,0],s=[0,0,-1,1],i=[];for(let c=0;c<8;c++)for(let l=0;l<8;l++){if(t[c][l]!==null||n[c][l])continue;const a=[[c,l]];let u=0,h=0;for(n[c][l]=!0;u<a.length;){const[y,M]=a[u++];h++;for(let m=0;m<4;m++){const b=y+r[m],d=M+s[m];b>=0&&b<8&&d>=0&&d<8&&!n[b][d]&&t[b][d]===null&&(n[b][d]=!0,a.push([b,d]))}}i.push(h)}let o=0;for(const c of i)o+=c%2===1?8:-8;return this.clamp(o,-100,100)}badMovePressure(t,e){const n=this.getOpponent(e),r=this.listValidMoves(t,n);if(r.length===0)return 28;let s=0;for(const o of r)(this.isX(o)||this.isC(o))&&s++;return(s/r.length*2-1)*36}internalDiscRatio(t,e){let n=0,r=0;for(let s=0;s<8;s++)for(let i=0;i<8;i++){if(t[s][i]!==e)continue;n++;let o=!0;for(const[c,l]of it){const a=s+c,u=i+l;if(a>=0&&a<8&&u>=0&&u<8&&t[a][u]===null){o=!1;break}}o&&r++}return n?(r/n*2-1)*48:0}calculateConfidenceFromCache(t,e,n,r){const s=t.emptyCount<=12?70:t.emptyCount<=20?62:t.emptyCount<=28?58:t.emptyCount<=44?54:50,i=this.getOpponent(n),o=this.countCorners(e,n)-this.countCorners(e,i),c=r*.12+o*5;return Math.max(10,Math.min(95,s+c))}calculateDepthByEmpties(t){return t<=12?20:t<=20?16:t<=32?12:8}calculateNodesByEmpties(t,e){const n=t>=44?8e3:t>=28?18e3:t>=12?3e4:42e3;return Math.round(n*(1+t/64*.4+Math.min(e/20,1)*.3))}countCorners(t,e){const n=[[0,0],[0,7],[7,0],[7,7]];let r=0;for(const[s,i]of n)t[s][i]===e&&r++;return r}calculatePV(t,e){return[]}evaluateCornerPotential(t,e,n){const r=[[0,0],[0,7],[7,0],[7,7]];let s=0,i=0,o=0,c=0;for(const[u,h]of r)t[u][h]===null&&(this.isValidMove(t,{row:u,col:h},e)&&(s+=1),this.isValidMove(t,{row:u,col:h},n)&&(i+=1),this.opensCornerNext(t,[u,h],e)&&(o+=1),this.opensCornerNext(t,[u,h],n)&&(c+=1));const l=(s-i)*40,a=(o-c)*20;return l+a}evaluateEdgeStructure(t,e,n){const r=[Array.from({length:8},(i,o)=>t[0][o]),Array.from({length:8},(i,o)=>t[7][o]),Array.from({length:8},(i,o)=>t[o][0]),Array.from({length:8},(i,o)=>t[o][7])];let s=0;for(const i of r){const o=new Array(8).fill(!1);if(i[0]===null)i[1]===e?s-=8:i[1]===n&&(s+=6);else if(i[0]===e)for(let l=1;l<=6&&i[l]===e;l++)s+=9,o[l]=!0;else if(i[0]===n)for(let l=1;l<=6&&i[l]===n;l++)s-=9,o[l]=!0;if(i[7]===null)i[6]===e?s-=8:i[6]===n&&(s+=6);else if(i[7]===e)for(let l=6;l>=1&&i[l]===e;l--)o[l]||(s+=9,o[l]=!0);else if(i[7]===n)for(let l=6;l>=1&&i[l]===n;l--)o[l]||(s-=9,o[l]=!0);let c=1;for(;c<=6;){if(o[c]||i[c]===null){c+=1;continue}const l=i[c];let a=c;for(;c<=6&&!o[c]&&i[c]===l;)c+=1;const u=c-1,h=i[a-1],y=i[u+1],M=u-a+1,m=h===null,b=y===null,d=m&&b;l===e?d?s-=M*4:m||b?s-=M*3:s+=M*3:l===n&&(d||m||b?s+=M*3:s-=M*3)}}return s}getDefaultWeights(){return{material:1,position:.9,mobility:1,frontier:1,stability:1,corner:.5,edge:.45,center:.3,safety:1,strategic:1}}initializePhaseWeights(){const t=new Map;return t.set("opening",{material:.1,position:1.1,mobility:1.45,frontier:1,stability:.6,corner:.45,edge:.3,center:.35,safety:1.15,strategic:1}),t.set("midgame",{material:.3,position:1.05,mobility:1.2,frontier:1,stability:.9,corner:.55,edge:.4,center:.3,safety:1,strategic:1}),t.set("late_midgame",{material:.55,position:.95,mobility:1,frontier:1.05,stability:1.2,corner:.6,edge:.5,center:.28,safety:.9,strategic:1}),t.set("endgame",{material:2,position:.55,mobility:.4,frontier:.5,stability:1.5,corner:.95,edge:.8,center:.2,safety:.7,strategic:1}),t}getBlendedWeights(t){const e=this.countEmptySquares(t),n=(l,a,u)=>l+(a-l)*u,r=(l,a,u)=>({material:n(l.material,a.material,u),position:n(l.position,a.position,u),mobility:n(l.mobility,a.mobility,u),frontier:n(l.frontier,a.frontier,u),stability:n(l.stability,a.stability,u),corner:n(l.corner,a.corner,u),edge:n(l.edge,a.edge,u),center:n(l.center,a.center,u),safety:n(l.safety,a.safety,u),strategic:n(l.strategic,a.strategic,u)}),s=this.phaseWeights.get("opening"),i=this.phaseWeights.get("midgame"),o=this.phaseWeights.get("late_midgame"),c=this.phaseWeights.get("endgame");if(e>=44){const l=Math.max(0,Math.min(1,(64-e)/20));return r(s,i,l)}else if(e>=28){const l=Math.max(0,Math.min(1,(44-e)/16));return r(i,o,l)}else if(e>=12){const l=Math.max(0,Math.min(1,(28-e)/16));return r(o,c,l)}else return c}countEmptySquares(t){let e=0;for(let n=0;n<8;n++)for(let r=0;r<8;r++)t[n][r]===null&&e++;return e}clamp(t,e,n){return t<e?e:t>n?n:t}getOpponent(t){return t==="black"?"white":"black"}getDefaultEvaluationResult(){return{score:0,depth:0,nodes:0,confidence:50,pv:[]}}}class he{constructor(){x(this,"gamePhase");x(this,"opponentProfile");this.gamePhase="opening",this.opponentProfile=null}analyzePosition(t,e,n,r){if(!t||!e||!n)return console.warn("StrategicAnalysis: 잘못된 입력 매개변수"),this.getDefaultAnalysisResult();this.gamePhase=n,this.opponentProfile=r;let s;try{s=this.analyzeMobility(t,e)}catch(o){console.warn("StrategicAnalysis: mobility 분석 실패",o),s=0}const i={mobility:s,frontier:this.analyzeFrontier(t,e),stability:this.analyzeStability(t,e),parity:this.analyzeParity(t,e),cornerControl:this.analyzeCornerControl(t,e),edgeControl:this.analyzeEdgeControl(t,e),centerControl:this.analyzeCenterControl(t,e),safety:this.analyzeSafety(t,e),summary:"",getMoveValue:o=>this.getMoveValue(o,t,e)};return i.summary=this.generateSummary(i),i}analyzeMobility(t,e){const n=this.getValidMoves(t,e).length,r=this.getValidMoves(t,this.getOpponent(e)).length,s=n+r;return s===0?0:(n-r)/s*100}analyzeFrontier(t,e){const n=this.countFrontierDiscs(t,e),r=this.countFrontierDiscs(t,this.getOpponent(e)),s=n+r;return s===0?0:(r-n)/s*100}analyzeStability(t,e){const n=this.countStableDiscs(t,e),r=this.countStableDiscs(t,this.getOpponent(e)),s=n+r;return s===0?0:(n-r)/s*100}analyzeParity(t,e){let n=0;for(let i=0;i<8;i++)for(let o=0;o<8;o++)t[i][o]===null&&n++;const r=e==="black";return n%2===(r?1:0)?20:-20}analyzeCornerControl(t,e){const n=[[0,0],[0,7],[7,0],[7,7]];let r=0,s=0,i=this.getOpponent(e);for(const[c,l]of n)t[c][l]===e?r++:t[c][l]===i&&s++;const o=r+s;return o===0?0:(r-s)/o*100}analyzeEdgeControl(t,e){let n=0,r=0,s=this.getOpponent(e);for(let o=0;o<8;o++)t[0][o]===e?n++:t[0][o]===s&&r++,t[7][o]===e?n++:t[7][o]===s&&r++;for(let o=1;o<=6;o++)t[o][0]===e?n++:t[o][0]===s&&r++,t[o][7]===e?n++:t[o][7]===s&&r++;const i=n+r;return i===0?0:(n-r)/i*100}analyzeCenterControl(t,e){const n=this.countInternalDiscs(t,e),r=this.countInternalDiscs(t,this.getOpponent(e)),s=n+r;return s===0?0:(n-r)/s*100}analyzeSafety(t,e){let n=0;const r=[[0,0],[0,7],[7,0],[7,7]];for(const[i,o]of r)t[i][o]===e&&(n+=8);const s=[[1,1,0,0],[1,6,0,7],[6,1,7,0],[6,6,7,7]];for(const[i,o,c,l]of s)t[i][o]===e&&t[c][l]===null&&(n-=15);return n+=this.edgeSafetyScan(t,e),n>100&&(n=100),n<-100&&(n=-100),n}getMoveValue(t,e,n){const r=this.simulateMove(e,t,n);if(!r)return-1e4;const s=this.getPositionValue(t),i=this.getPhaseValue(t,e,n),o=this.isSafeMove(t,e,n),c=this.isDangerousMove(t,e,n),l=this.opponentProfile?this.getOpponentSpecificValue(t,e,n):0;let a=0;this.isCorner(t)&&(a+=40),this.isEdge(t)&&(a+=8),o&&(a+=12),c&&(a-=20);const u=this.getOpponent(n),h=this.countFrontierDiscs(e,n),y=this.countFrontierDiscs(e,u),M=this.countFrontierDiscs(r,n),m=this.countFrontierDiscs(r,u),b=M-h-(m-y),E=6*(this.gamePhase==="opening"?1.2:this.gamePhase==="midgame"?.85:this.gamePhase==="late_midgame"?.45:0);let C=0;b>0&&(C-=b*E);const _=this.getValidMoves(r,n).length,S=this.getValidMoves(r,u).length-_;S>3&&(C-=Math.min(15,(S-3)*3));const G=this.cornerGiveawayPenalty(e,r,n),z=this.xSacrificeJustification(e,r,t,n),R=this.veryEarlyXPenalty(t,e,z);return s*.6+i+a+l+C+G+z+R}isXSquare(t){const{row:e,col:n}=t;return e===1&&n===1||e===1&&n===6||e===6&&n===1||e===6&&n===6}cornerForX(t){const{row:e,col:n}=t;return e===1&&n===1?[0,0]:e===1&&n===6?[0,7]:e===6&&n===1?[7,0]:e===6&&n===6?[7,7]:null}cornerGiveawayPenalty(t,e,n){const r=this.getOpponent(n),s=[[0,0],[0,7],[7,0],[7,7]].filter(([c,l])=>t[c][l]===null);if(s.length===0)return 0;const i=this.getValidMoves(e,r);if(i.length===0)return 0;let o=0;for(const[c,l]of s)if(i.some(a=>a.row===c&&a.col===l)){const a=this.gamePhase==="opening"?1.3:this.gamePhase==="midgame"?1.1:this.gamePhase==="late_midgame"?.6:0;o-=Math.round(80*a)}return o}xSacrificeJustification(t,e,n,r){if(!this.isXSquare(n))return 0;const s=this.cornerForX(n);if(!s)return 0;const[i,o]=s;if(t[i][o]!==null)return 0;let c=0;for(let C=0;C<8;C++)for(let _=0;_<8;_++)t[C][_]===null&&c++;if(c>20)return-50;const l=this.getOpponent(r);if(!this.getValidMoves(e,l).some(C=>C.row===i&&C.col===o))return 0;const u=this.simulateMove(e,{row:i,col:o},l);if(!u)return 0;const h=this.getValidMoves(u,r);if(h.length===0)return-100;const y=[[0,0],[0,7],[7,0],[7,7]],M=h.some(C=>y.some(([_,v])=>C.row===_&&C.col===v));if(!M)return-30;let m=0;M&&(m+=50);let b=-1e9,d=null;for(const C of h.slice(0,8)){const _=this.simulateMove(u,C,r);if(!_)continue;const v=this.getValidMoves(_,r).length,S=this.getValidMoves(_,l).length,G=(v-S)*3,z=this.countFrontierDiscs(_,r),A=(this.countFrontierDiscs(_,l)-z)*2,V=this.isCorner(C)?30:0,$=this.isEdge(C)&&this.isEdgeSafe(C,_)?5:0,B=G+A+V+$;B>b&&(b=B,d=_)}b>10&&(m+=Math.min(b,40)),d&&this.getValidMoves(d,l).length===0&&(m+=20);const E=this.gamePhase==="opening"?.3:this.gamePhase==="midgame"?.7:this.gamePhase==="late_midgame"?1:.5;return m=Math.max(-50,Math.min(30,Math.round(m*E))),m}veryEarlyXPenalty(t,e,n){if(!this.isXSquare(t))return 0;const r=this.cornerForX(t);if(!r)return 0;const[s,i]=r;if(e[s][i]!==null)return 0;let o=0;for(let l=0;l<8;l++)for(let a=0;a<8;a++)e[l][a]===null&&o++;if(o<50)return 0;const c=-80;return n>=50?0:n>0?Math.floor(c/2):c}isCorner(t){const{row:e,col:n}=t;return(e===0||e===7)&&(n===0||n===7)}isEdge(t){const{row:e,col:n}=t;return e===0||e===7||n===0||n===7}isCenter4(t){const{row:e,col:n}=t;return e>=3&&e<=4&&n>=3&&n<=4}isSafeMove(t,e,n){return this.isCorner(t)?!0:!(this.isDangerousSquare(t,e)||this.isEdge(t)&&!this.isEdgeSafe(t,e))}isDangerousMove(t,e,n){return this.isDangerousSquare(t,e)}isDangerousSquare(t,e){const{row:n,col:r}=t,s=[[1,1,0,0],[1,6,0,7],[6,1,7,0],[6,6,7,7]];for(const[o,c,l,a]of s)if(n===o&&r===c&&e[l][a]===null)return!0;const i=[{corner:[0,0],cells:[[0,1],[1,0]]},{corner:[0,7],cells:[[0,6],[1,7]]},{corner:[7,0],cells:[[6,0],[7,1]]},{corner:[7,7],cells:[[6,7],[7,6]]}];for(const o of i){const[c,l]=o.corner;if(e[c][l]===null){for(const[a,u]of o.cells)if(n===a&&r===u)return!0}}return!1}isEdgeSafe(t,e){const{row:n,col:r}=t;return!(n===0&&(r<=1&&e[0][0]===null||r>=6&&e[0][7]===null)||n===7&&(r<=1&&e[7][0]===null||r>=6&&e[7][7]===null)||r===0&&(n<=1&&e[0][0]===null||n>=6&&e[7][0]===null)||r===7&&(n<=1&&e[0][7]===null||n>=6&&e[7][7]===null))}edgeSafetyScan(t,e){let n=0;const r=e;return t[0][0]===null&&(t[0][1]===r&&(n-=4),t[1][0]===r&&(n-=4)),t[0][7]===null&&(t[0][6]===r&&(n-=4),t[1][7]===r&&(n-=4)),t[7][0]===null&&(t[7][1]===r&&(n-=4),t[6][0]===r&&(n-=4)),t[7][7]===null&&(t[7][6]===r&&(n-=4),t[6][7]===r&&(n-=4)),n}getPhaseValue(t,e,n){const r=this.getMobilityValue(t,e,n),s=this.getStabilityValue(t,e,n),i=this.getMaterialValue(t,e,n),o=this.getPositionValue(t);switch(this.gamePhase){case"opening":return Math.max(-50,Math.min(50,r))*.5+o*.4;case"midgame":return r*.5+o*.3+s*.6;case"late_midgame":return s*.9+this.getCornerValue(t)*.6+o*.2;case"endgame":return i*.8+s*.4+o*.1;default:return 0}}getOpponentSpecificValue(t,e,n){if(!this.opponentProfile)return 0;const r=this.getStabilityValue(t,e,n),s=this.getMobilityValue(t,e,n);switch(this.opponentProfile.style){case"aggressive":return r*.3;case"defensive":return s*.3;case"balanced":return(r+s)*.15;default:return 0}}getMobilityValue(t,e,n){const r=this.simulateMove(e,t,n);if(!r)return-1e3;const s=this.getValidMoves(r,n).length,i=this.getValidMoves(r,this.getOpponent(n)).length;return(s-i)*10}getPositionValue(t){return[[120,-20,20,5,5,20,-20,120],[-20,-60,-5,-5,-5,-5,-60,-20],[20,-5,15,3,3,15,-5,20],[5,-5,3,3,3,3,-5,5],[5,-5,3,3,3,3,-5,5],[20,-5,15,3,3,15,-5,20],[-20,-60,-5,-5,-5,-5,-60,-20],[120,-20,20,5,5,20,-20,120]][t.row][t.col]}getStabilityValue(t,e,n){return this.isCorner(t)?100:this.isCenter4(t)?6:this.isEdge(t)&&this.isEdgeSafe(t,e)?24:0}getCornerValue(t){return this.isCorner(t)?100:0}getMaterialValue(t,e,n){const r=this.simulateMove(e,t,n);if(!r)return-1e3;const s=this.countPieces(r,n),i=this.countPieces(r,this.getOpponent(n));return(s-i)*5}simulateMove(t,e,n){const{row:r,col:s}=e;if(t[r][s]!==null)return null;const i=t.map(a=>[...a]),o=this.getOpponent(n),c=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];let l=0;i[r][s]=n;for(const[a,u]of c){const h=this.getFlipsInDirection(i,r,s,a,u,n,o);if(h.length)for(const{row:y,col:M}of h)i[y][M]=n,l++}return l===0?null:i}getFlipsInDirection(t,e,n,r,s,i,o){const c=[];let l=e+r,a=n+s;for(;l>=0&&l<8&&a>=0&&a<8;){const u=t[l][a];if(u===o)c.push({row:l,col:a});else{if(u===i)return c.length?c:[];break}l+=r,a+=s}return[]}getValidMoves(t,e){const n=[];for(let r=0;r<8;r++)for(let s=0;s<8;s++)t[r][s]===null&&this.isValidMove(t,{row:r,col:s},e)&&n.push({row:r,col:s});return n}isValidMove(t,e,n){const{row:r,col:s}=e;if(t[r][s]!==null)return!1;const i=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],o=this.getOpponent(n);for(const[c,l]of i)if(this.canFlipInDirection(t,r,s,c,l,n,o))return!0;return!1}canFlipInDirection(t,e,n,r,s,i,o){let c=e+r,l=n+s,a=!1;for(;c>=0&&c<8&&l>=0&&l<8;){const u=t[c][l];if(u===o)a=!0;else{if(u===i)return a;break}c+=r,l+=s}return!1}countPieces(t,e){let n=0;for(let r=0;r<8;r++)for(let s=0;s<8;s++)t[r][s]===e&&n++;return n}getOpponent(t){return t==="black"?"white":"black"}countFrontierDiscs(t,e){let n=0;const r=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(let s=0;s<8;s++)for(let i=0;i<8;i++){if(t[s][i]!==e)continue;let o=!1;for(const[c,l]of r){const a=s+c,u=i+l;if(!(a<0||a>7||u<0||u>7)&&t[a][u]===null){o=!0;break}}o&&n++}return n}countInternalDiscs(t,e){let n=0;const r=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(let s=0;s<8;s++)for(let i=0;i<8;i++){if(t[s][i]!==e)continue;let o=!0;for(const[c,l]of r){const a=s+c,u=i+l;if(!(a<0||a>7||u<0||u>7)&&t[a][u]===null){o=!1;break}}o&&n++}return n}countStableDiscs(t,e){const n=new Set,r=[{r:0,c:0,dirs:[[0,1],[1,0]]},{r:0,c:7,dirs:[[0,-1],[1,0]]},{r:7,c:0,dirs:[[-1,0],[0,1]]},{r:7,c:7,dirs:[[-1,0],[0,-1]]}];for(const{r:s,c:i,dirs:o}of r)if(t[s][i]===e){n.add(`${s},${i}`);for(const[c,l]of o){let a=s+c,u=i+l;for(;a>=0&&a<8&&u>=0&&u<8&&t[a][u]===e;)n.add(`${a},${u}`),a+=c,u+=l}}return n.size}generateSummary(t){const e=[];return t.mobility>25?e.push("모빌리티 우위"):t.mobility<-25&&e.push("모빌리티 열위"),t.cornerControl>50?e.push("코너 컨트롤 우세"):t.cornerControl<-50&&e.push("코너 불리"),t.stability>25?e.push("형태 안정적"):t.stability<-25&&e.push("형태 불안정"),t.frontier>20?e.push("상대 외곽 증가 유도 성공"):t.frontier<-20&&e.push("내 외곽 과다"),t.centerControl>20?e.push("내부 디스크 우세"):t.centerControl<-20&&e.push("내부 디스크 열세"),t.parity>0?e.push("패리티 유리"):e.push("패리티 불리"),t.safety>20?e.push("안전한 국면"):t.safety<-20&&e.push("위험한 국면"),e.length?e.join(", "):"균형 상태"}getDefaultAnalysisResult(){return{mobility:0,frontier:0,stability:0,parity:0,cornerControl:0,edgeControl:0,centerControl:0,safety:0,summary:"분석 실패",getMoveValue:()=>0}}}class ge{constructor(){x(this,"analysisHistory",[]);x(this,"patternDatabase",new Map);this.initializePatternDatabase()}analyzeOpponent(t,e){if(!t||!e||!Array.isArray(e))return console.warn("OpponentAnalysis: 잘못된 입력 매개변수"),this.getDefaultProfile();const n=this.analyzeMovePatternsFallback(e),r=this.analyzeStrategicPreferencesFallback(e),s=this.analyzeWeaknessTendenciesFallback(e,t),i=this.determinePlayingStyle(n,r),o={style:i,preferences:r,weaknesses:s,summary:this.generateProfileSummary(i,r,s)};return this.storeAnalysis(o,e),o}analyzeOpponentWithContext(t,e){const n=e.map(l=>l.move),r=this.analyzeMovePatternsCtx(e),s=this.analyzeStrategicPreferencesCtx(e),i=this.analyzeWeaknessTendenciesCtx(e,t),o=this.determinePlayingStyle(r,s),c={style:o,preferences:s,weaknesses:i,summary:this.generateProfileSummary(o,s,i)};return this.storeAnalysis(c,n),c}getAnalysisStats(){const t=this.analysisHistory.length||1;return{totalAnalyses:this.analysisHistory.length,uniqueOpponents:new Set(this.analysisHistory.map(e=>e.opponentId??e.profile.summary)).size,averageMoves:this.analysisHistory.reduce((e,n)=>e+n.moves.length,0)/t,patternCount:this.patternDatabase.size}}analyzeMovePatternsFallback(t){const e={cornerPreference:0,edgePreference:0,centerPreference:0,mobilityStyle:.5,riskTolerance:.5,consistency:1};if(t.length===0)return e;const n=t.filter(i=>this.isCorner(i)).length,r=t.filter(i=>this.isEdge(i)).length,s=t.filter(i=>this.isCenter(i)).length;return e.cornerPreference=n/t.length,e.edgePreference=r/t.length,e.centerPreference=s/t.length,e.mobilityStyle=this.analyzeMobilityStyleFallback(t),e.riskTolerance=this.analyzeRiskToleranceFallback(t),e.consistency=this.analyzeConsistency(t),e}analyzeMovePatternsCtx(t){const e=t.map(r=>r.move),n=this.analyzeMovePatternsFallback(e);return n.mobilityStyle=this.analyzeMobilityStyleCtx(t),n.riskTolerance=this.analyzeRiskToleranceCtx(t),n.consistency=this.analyzeConsistency(e),n}analyzeStrategicPreferencesFallback(t){const e=[];if(t.length===0)return e;const n=t.filter(c=>this.isCorner(c)).length/t.length,r=t.filter(c=>this.isEdge(c)).length/t.length,s=t.filter(c=>this.isCenter(c)).length/t.length;return n>.3&&e.push("corner_control"),r>.4&&e.push("edge_control"),s>.2&&e.push("center_control"),this.analyzeMobilityStyleFallback(t)>.55&&e.push("mobility_focus"),this.analyzeStabilityPreferenceFallback(t)>.55&&e.push("stability_focus"),e}analyzeStrategicPreferencesCtx(t){const e=t.map(i=>i.move);if(e.length===0)return[];const n=this.analyzeStrategicPreferencesFallback(e),r=this.analyzeStabilityPreferenceCtx(t),s=n.indexOf("stability_focus");return r>.55?s===-1&&n.push("stability_focus"):s!==-1&&n.splice(s,1),n}analyzeWeaknessTendenciesFallback(t,e){const n=[];return t.length===0||(t.some(o=>this.isXSquare(o))&&n.push("x_square_risky_tendency"),t.some(o=>this.isCSquare(o))&&n.push("c_square_risky_tendency"),this.analyzeMobilityRiskFallback(t)>.3&&n.push("mobility_risky_tendency"),this.analyzeTimingTendencyFallback(t)>.3&&n.push("timing_tendency"),this.analyzeEndgameTendencyFallback(t)>.3&&n.push("endgame_risky_tendency")),n}analyzeWeaknessTendenciesCtx(t,e){const n=[];if(t.length===0)return n;const r=t.map(c=>c.move);return t.some(c=>this.isDangerousSquareOn(c.boardBefore,c.move))&&n.push("x_or_c_empty_corner_risk"),this.analyzeMobilityRiskCtx(t)>.3&&n.push("mobility_risky_tendency"),this.analyzeTimingTendencyCtx(t)>.3&&n.push("timing_tendency"),this.analyzeEndgameTendencyCtx(t)>.3&&n.push("endgame_risky_tendency"),r.some(c=>this.isXSquare(c))&&n.push("x_square_usage"),r.some(c=>this.isCSquare(c))&&n.push("c_square_usage"),n}determinePlayingStyle(t,e){let n=0,r=0;return t.riskTolerance>.6&&(n+=2),e.includes("mobility_focus")&&(n+=1),t.consistency<.5&&(n+=1),t.edgePreference>.5&&(r+=1),t.centerPreference<.2&&t.cornerPreference>.25&&(r+=2),e.includes("stability_focus")&&(r+=2),t.consistency>.7&&(r+=1),n>r+1?"aggressive":r>n+1?"defensive":"balanced"}generateProfileSummary(t,e,n){const r=[];return r.push(t==="aggressive"?"Aggressive player":t==="defensive"?"Defensive player":"Balanced player"),e.length&&r.push(`Prefers: ${e.join(", ")}`),n.length&&r.push(`Tendencies: ${n.join(", ")}`),r.join(" | ")}storeAnalysis(t,e){const n={timestamp:Date.now(),profile:t,moves:[...e],patterns:this.extractPatterns(e)};this.analysisHistory.push(n),this.analysisHistory.length>100&&this.analysisHistory.shift()}extractPatterns(t){const e=[];return t.some(n=>this.isCorner(n))&&e.push("corner_play"),t.some(n=>this.isEdge(n))&&e.push("edge_play"),t.some(n=>this.isCenter(n))&&e.push("center_play"),t.some(n=>this.isXSquare(n))&&e.push("x_square_play"),t.some(n=>this.isCSquare(n))&&e.push("c_square_play"),e}isCorner(t){const{row:e,col:n}=t;return(e===0||e===7)&&(n===0||n===7)}isEdge(t){const{row:e,col:n}=t;return e===0||e===7||n===0||n===7}isCenter(t){const{row:e,col:n}=t;return e>=3&&e<=4&&n>=3&&n<=4}isXSquare(t){const{row:e,col:n}=t;return e===1&&n===1||e===1&&n===6||e===6&&n===1||e===6&&n===6}isCSquare(t){const{row:e,col:n}=t;return e===0&&(n===1||n===6)||e===1&&(n===0||n===7)||e===6&&(n===0||n===7)||e===7&&(n===1||n===6)}analyzeConsistency(t){if(t.length<2)return 1;const e=s=>this.isCorner(s)?"corner":this.isXSquare(s)?"x":this.isCSquare(s)?"c":this.isEdge(s)?"edge":this.isCenter(s)?"center":"other";let n=0,r=e(t[0]);for(let s=1;s<t.length;s++){const i=e(t[s]);i!==r&&n++,r=i}return 1-n/(t.length-1)}analyzeMobilityStyleFallback(t){if(t.length===0)return .5;const e=new Set(t.map(i=>i.row)).size,n=new Set(t.map(i=>i.col)).size,r=(e+n)/(Math.min(8,t.length)*2),s=t.filter(i=>i.row>=2&&i.row<=5&&i.col>=2&&i.col<=5).length/t.length;return Math.min(1,r*.6+s*.4)}analyzeMobilityStyleCtx(t){if(t.length===0)return .5;let e=0,n=0;for(const s of t){const i=this.getOpponent(s.player),o=this.getValidMoves(s.boardBefore,s.player).length,c=this.getValidMoves(s.boardBefore,i).length,l=this.simulateMove(s.boardBefore,s.move,s.player);if(!l)continue;const a=this.getValidMoves(l,s.player).length,u=this.getValidMoves(l,i).length,h=a-o-(u-c);e+=h,n++}if(!n)return this.analyzeMobilityStyleFallback(t.map(s=>s.move));const r=e/n;return Math.max(0,Math.min(1,.5+r/12))}analyzeRiskToleranceFallback(t){if(t.length===0)return .5;let e=0;return e+=t.filter(n=>this.isXSquare(n)).length*.3,e+=t.filter(n=>this.isCSquare(n)).length*.2,e-=t.filter(n=>this.isCorner(n)).length*.1,Math.max(0,Math.min(1,.5+e/t.length))}analyzeRiskToleranceCtx(t){if(t.length===0)return .5;let e=0;for(const n of t)this.isCorner(n.move)?e-=.25:this.isDangerousSquareOn(n.boardBefore,n.move)?e+=.6:(this.isCSquare(n.move)||this.isXSquare(n.move))&&(e+=.2);return Math.max(0,Math.min(1,.5+e/(t.length*1.2)))}analyzeStabilityPreferenceFallback(t){const e=t.filter(n=>this.isCorner(n)||this.isEdge(n)).length;return t.length?e/t.length:.5}analyzeStabilityPreferenceCtx(t){if(t.length===0)return .5;let e=0;for(const n of t){if(this.isCorner(n.move)){e++;continue}this.isEdge(n.move)&&this.isEdgeSafeOn(n.boardBefore,n.move)&&e++}return e/t.length}analyzeMobilityRiskFallback(t){if(t.length===0)return 0;let e=0;const n=t.filter(r=>this.isXSquare(r)||this.isCSquare(r)).length;return e+=n*.3,e+=this.findClusteredPairs(t)*.05,Math.min(1,e/Math.max(1,t.length))}analyzeMobilityRiskCtx(t){if(t.length===0)return 0;let e=0,n=0;for(const r of t){const s=this.getOpponent(r.player),i=this.getValidMoves(r.boardBefore,r.player).length,o=this.getValidMoves(r.boardBefore,s).length,c=this.simulateMove(r.boardBefore,r.move,r.player);if(!c)continue;const l=this.getValidMoves(c,r.player).length,a=this.getValidMoves(c,s).length;l-i<0&&a-o>0&&e++,n++}return n?e/n:0}analyzeTimingTendencyFallback(t){if(t.length===0)return 0;const e=t.slice(0,Math.min(10,t.length)),n=t.slice(-Math.min(10,t.length));let r=0;return r+=e.filter(s=>this.isCorner(s)).length*.1,r+=n.filter(s=>this.isXSquare(s)||this.isCSquare(s)).length*.2,Math.min(1,r/Math.max(1,t.length))}analyzeTimingTendencyCtx(t){if(t.length===0)return 0;const e=Math.min(10,t.length),n=t.slice(0,e),r=t.slice(-e);let s=0;s+=n.filter(o=>this.isDangerousSquareOn(o.boardBefore,o.move)).length*.2;const i=r.filter(o=>this.isDangerousSquareOn(o.boardBefore,o.move)||this.isXSquare(o.move)||this.isCSquare(o.move)).length;return s+=i*.25,Math.min(1,s/Math.max(1,t.length))}analyzeEndgameTendencyFallback(t){if(t.length===0)return 0;const e=Math.min(20,t.length),n=t.slice(-e);let r=0;return n.filter(i=>this.isCorner(i)).length/e<.3&&(r+=.4),r+=n.filter(i=>this.isXSquare(i)||this.isCSquare(i)).length*.2,Math.min(1,r)}analyzeEndgameTendencyCtx(t){if(t.length===0)return 0;const e=Math.min(20,t.length),n=t.slice(-e);let r=0;n.filter(o=>this.isCorner(o.move)).length/e<.3&&(r+=.35);const i=n.filter(o=>this.isDangerousSquareOn(o.boardBefore,o.move)||this.isXSquare(o.move)||this.isCSquare(o.move)).length;return r+=i*.25,Math.min(1,r)}findClusteredPairs(t){if(t.length<3)return 0;let e=0;for(let n=0;n<t.length-1;n++)for(let r=n+1;r<t.length;r++)Math.abs(t[n].row-t[r].row)+Math.abs(t[n].col-t[r].col)<=2&&e++;return e}isDangerousSquareOn(t,e){const{row:n,col:r}=e,s=[[1,1,0,0],[1,6,0,7],[6,1,7,0],[6,6,7,7]];for(const[o,c,l,a]of s)if(n===o&&r===c&&t[l][a]===null)return!0;const i=[{corner:[0,0],cells:[[0,1],[1,0]]},{corner:[0,7],cells:[[0,6],[1,7]]},{corner:[7,0],cells:[[6,0],[7,1]]},{corner:[7,7],cells:[[6,7],[7,6]]}];for(const o of i){const[c,l]=o.corner;if(t[c][l]===null){for(const[a,u]of o.cells)if(n===a&&r===u)return!0}}return!1}isEdgeSafeOn(t,e){const{row:n,col:r}=e;return!(n===0&&(r<=1&&t[0][0]===null||r>=6&&t[0][7]===null)||n===7&&(r<=1&&t[7][0]===null||r>=6&&t[7][7]===null)||r===0&&(n<=1&&t[0][0]===null||n>=6&&t[7][0]===null)||r===7&&(n<=1&&t[0][7]===null||n>=6&&t[7][7]===null))}getOpponent(t){return t==="black"?"white":"black"}simulateMove(t,e,n){if(t[e.row][e.col]!==null)return null;const r=t.map(c=>[...c]),s=this.getOpponent(n),i=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];let o=0;r[e.row][e.col]=n;for(const[c,l]of i){const a=[];let u=e.row+c,h=e.col+l;for(;u>=0&&u<8&&h>=0&&h<8&&r[u][h]===s;)a.push({row:u,col:h}),u+=c,h+=l;if(u>=0&&u<8&&h>=0&&h<8&&r[u][h]===n&&a.length)for(const y of a)r[y.row][y.col]=n,o++}return o?r:null}getValidMoves(t,e){const n=[];for(let r=0;r<8;r++)for(let s=0;s<8;s++)t[r][s]===null&&this.isValidMove(t,{row:r,col:s},e)&&n.push({row:r,col:s});return n}isValidMove(t,e,n){if(t[e.row][e.col]!==null)return!1;const r=this.getOpponent(n),s=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[i,o]of s)if(this.canFlip(t,e.row,e.col,i,o,n,r))return!0;return!1}canFlip(t,e,n,r,s,i,o){let c=e+r,l=n+s,a=!1;for(;c>=0&&c<8&&l>=0&&l<8;){const u=t[c][l];if(u===o)a=!0;else{if(u===i)return a;break}c+=r,l+=s}return!1}initializePatternDatabase(){this.patternDatabase.set("corner_control",{name:"Corner Control",description:"Focuses on controlling corners",strength:.8,weakness:.2}),this.patternDatabase.set("edge_control",{name:"Edge Control",description:"Focuses on controlling edges",strength:.6,weakness:.4}),this.patternDatabase.set("mobility_focus",{name:"Mobility Focus",description:"Focuses on maintaining mobility",strength:.7,weakness:.3})}getDefaultProfile(){return{style:"balanced",preferences:[],weaknesses:[],summary:"분석 실패"}}}const Xt=0xffffffffffffffffn;function pe(f,t){return(7-f)*8+t}function Zt(f){return f&&typeof f.length=="number"&&typeof f.subarray=="function"}function me(f){const t=new Uint8Array(64);for(let e=0;e<8;e++)for(let n=0;n<8;n++){const r=f[e][n];t[e*8+n]=r==="black"?1:r==="white"?2:0}return t}function ye(f){let t=0n,e=0n;for(let n=0;n<64;n++){const r=f[n]|0;if(r===0)continue;const s=n/8|0,i=n%8,o=pe(s,i),c=1n<<BigInt(o);r===1?t|=c:r===2&&(e|=c)}return{bp:t,wp:e}}function Jt(f){let t;if(Zt(f)?t=f:Array.isArray(f)&&Array.isArray(f[0])?t=me(f):Array.isArray(f)?t=Uint8Array.from(f):f&&f.cells&&Zt(f.cells)?t=f.cells:t=new Uint8Array(64),t._bp===void 0||t._wp===void 0){const{bp:e,wp:n}=ye(t);t._bp=e,t._wp=n}return t}function de(f){return f==="black"?1:2}function we(f,t){const e=de(t),n=Jt(f),r=0x100000001b3n,s=0x100000001b5n;let i=0xcbf29ce484222325n;return i^=n._bp*r&Xt,i*=s,i^=n._wp*s&Xt,i*=r,i^=BigInt(e&3),i*=0x100000001b7n,Number(i&0xffffffffffffffffn)}class Me{constructor(){x(this,"scenarioCache",new Map);x(this,"predictionHistory",[]);x(this,"SCENARIOS",24);x(this,"MAX_DEPTH",16);x(this,"EPSILON",.25);this.initializePredictionModels()}analyzeFutureScenarios(t,e,n){if(!t||!e||typeof n!="number"||n<0)return console.warn("PredictiveSearch: 잘못된 입력 매개변수"),this.getDefaultInsights();const r=Math.min(n,this.MAX_DEPTH),s=this.generateScenarios(t,e,r),i=this.softmax(s.map(h=>h.score));s.forEach((h,y)=>h.probability=i[y]);const o=s.map(h=>h.board),c=s.map(h=>h.probability),a=[...s].sort((h,y)=>y.score-h.score).map(h=>h.moves),u={scenarios:o,probabilities:c,bestPaths:a,summary:this.generateSummary(o,c,a),getMoveValue:h=>this.getMoveValue(h,s)};return this.storePrediction(u,t,e),u}generateScenarios(t,e,n){const r=this.generateCacheKey(t,e,n),s=this.scenarioCache.get(r);if(s)return s;const i=[];for(let o=0;o<this.SCENARIOS;o++)i.push(this.simulateGame(t,e,n));return this.scenarioCache.set(r,i),i}simulateGame(t,e,n){let r=this.copyBoard(t),s=e;const i=[];let o=0,c=0;for(;o<n;){const a=this.getValidMoves(r,s);if(a.length===0){if(c++,c===2)break;s=this.getOpponent(s),o++;continue}c=0;const u=this.selectMoveEpsilonGreedy(r,s,a),h=this.makeMove(r,u,s);if(!h)break;r=h,i.push(u),s=this.getOpponent(s),o++}const l=this.evaluateBoard(r,e);return{board:r,moves:i,score:l,depth:i.length,probability:0}}selectMoveEpsilonGreedy(t,e,n){if(Math.random()<this.EPSILON)return n[Math.floor(Math.random()*n.length)];let r=n[0],s=-1/0;for(const i of n){const o=this.quickMoveHeuristic(t,e,i);o>s&&(s=o,r=i)}return r}quickMoveHeuristic(t,e,n){const r=this.getPositionalWeight(n.row,n.col),s=this.xcRisk(n,t),i=this.makeMove(t,n,e);if(!i)return-999;const o=this.getValidMoves(i,e).length,c=this.getValidMoves(i,this.getOpponent(e)).length;return r-s+(o-c)*2}xcRisk(t,e){const{row:n,col:r}=t,s=[[1,1,0,0],[1,6,0,7],[6,1,7,0],[6,6,7,7]];for(const[o,c,l,a]of s)if(n===o&&r===c&&e[l][a]===null)return 30;const i=[{corner:[0,0],cells:[[0,1],[1,0]]},{corner:[0,7],cells:[[0,6],[1,7]]},{corner:[7,0],cells:[[6,0],[7,1]]},{corner:[7,7],cells:[[6,7],[7,6]]}];for(const o of i){const[c,l]=o.corner;if(e[c][l]===null){for(const[a,u]of o.cells)if(n===a&&r===u)return 18}}return 0}softmax(t){if(t.length===0)return[];const e=Math.max(...t),n=t.map(s=>Math.exp((s-e)/100)),r=n.reduce((s,i)=>s+i,0);return n.map(s=>s/(r||1))}getMoveValue(t,e){let n=0;for(const r of e)if(r.moves.length>0){const s=r.moves[0];s.row===t.row&&s.col===t.col?n+=r.probability*100:r.moves.some(i=>i.row===t.row&&i.col===t.col)&&(n+=r.probability*20)}return n}generateSummary(t,e,n){const r=t.length||1,s=e.reduce((o,c)=>o+c,0)/r,i=n.reduce((o,c)=>o+c.length,0)/r;return`Scenarios=${r}, avgP=${(s*100).toFixed(1)}%, avgLen=${i.toFixed(1)}`}storePrediction(t,e,n){const r={timestamp:Date.now(),board:this.copyBoard(e),player:n,insights:t,accuracy:0};this.predictionHistory.push(r),this.predictionHistory.length>200&&this.predictionHistory.shift()}getPredictionStats(){const t=this.predictionHistory.length||1;return{totalPredictions:this.predictionHistory.length,averageAccuracy:this.predictionHistory.reduce((e,n)=>e+n.accuracy,0)/t,cacheSize:this.scenarioCache.size,averageScenarios:this.predictionHistory.reduce((e,n)=>e+n.insights.scenarios.length,0)/t}}initializePredictionModels(){}getDefaultInsights(){return{scenarios:[],probabilities:[],bestPaths:[],summary:"예측 실패",getMoveValue:()=>0}}getValidMoves(t,e){const n=[];for(let r=0;r<8;r++)for(let s=0;s<8;s++)t[r][s]===null&&this.isValidMove(t,{row:r,col:s},e)&&n.push({row:r,col:s});return n}isValidMove(t,e,n){const{row:r,col:s}=e;if(t[r][s]!==null)return!1;const i=this.getOpponent(n),o=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[c,l]of o)if(this.canFlip(t,r,s,c,l,n,i))return!0;return!1}canFlip(t,e,n,r,s,i,o){let c=e+r,l=n+s,a=!1;for(;c>=0&&c<8&&l>=0&&l<8;){const u=t[c][l];if(u===o)a=!0;else{if(u===i)return a;break}c+=r,l+=s}return!1}makeMove(t,e,n){if(!this.isValidMove(t,e,n))return null;const r=this.copyBoard(t);r[e.row][e.col]=n;const s=this.getOpponent(n),i=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];for(const[o,c]of i){const l=this.collectFlips(r,e.row,e.col,o,c,n,s);for(const a of l)r[a.row][a.col]=n}return r}collectFlips(t,e,n,r,s,i,o){const c=[];let l=e+r,a=n+s;for(;l>=0&&l<8&&a>=0&&a<8;){const u=t[l][a];if(u===o)c.push({row:l,col:a});else{if(u===i)return c.length?c:[];break}l+=r,a+=s}return[]}evaluateBoard(t,e){const n=this.getOpponent(e);let r=0,s=0,i=0;for(let u=0;u<8;u++)for(let h=0;h<8;h++){const y=t[u][h];y===e?(r+=this.getPositionalWeight(u,h),s++):y===n&&(r-=this.getPositionalWeight(u,h),i++)}const o=this.getValidMoves(t,e).length,c=this.getValidMoves(t,n).length,l=s-i,a=(o-c)*4;return r+a+l*1.5}getPositionalWeight(t,e){return[[120,-20,20,5,5,20,-20,120],[-20,-40,-5,-5,-5,-5,-40,-20],[20,-5,15,3,3,15,-5,20],[5,-5,3,3,3,3,-5,5],[5,-5,3,3,3,3,-5,5],[20,-5,15,3,3,15,-5,20],[-20,-40,-5,-5,-5,-5,-40,-20],[120,-20,20,5,5,20,-20,120]][t][e]}copyBoard(t){return t.map(e=>[...e])}generateCacheKey(t,e,n){const r=Jt(t),s=we(r,e);return`${e}_${n}_${s}`}getOpponent(t){return t==="black"?"white":"black"}}class ve{constructor(){x(this,"name","AdaptiveStrategy");x(this,"strategyHistory",[]);x(this,"adaptationRules",new Map);x(this,"currentStrategy");x(this,"ctx");this.currentStrategy=this.getDefaultStrategy(),this.initializeAdaptationRules()}beginTurn(t,e,n){this.ctx={board:t,player:e,opp:e==="black"?"white":"black",analysis:{mobility:n.mobility??0,frontier:n.frontier??0,stability:n.stability??0,cornerControl:n.cornerControl??0,edgeControl:n.edgeControl??0,centerControl:n.centerControl??0,safety:n.safety??0}}}adaptStrategy(t,e,n){if(!t||!n)return console.warn("AdaptiveStrategy: 잘못된 입력 매개변수"),this;const r=this.analyzeSituation(t,e),s=this.determineAdaptationNeeds(r,n);for(const[,i]of this.adaptationRules)i.condition(r)&&i.action(this.currentStrategy);return this.applyAdaptations(s),this.storeStrategyChange(r,s),this}getMoveValue(t){if(!this.ctx)return 0;const{board:e,player:n,opp:r}=this.ctx,s=this.simulateMove(e,t,n);if(!s)return-1e6;const i=this.getValidMoves(s,n).length,o=this.getValidMoves(s,r).length,c=i-o,l=this.countFrontierDiscs(e,n),a=this.countFrontierDiscs(e,r),u=this.countFrontierDiscs(s,n),y=this.countFrontierDiscs(s,r)-u-(a-l),M=this.isCorner(t)?4:this.isEdgeSafe(t,e)?1:0;let m=0;m+=(this.isCorner(t)?100:0)*this.currentStrategy.cornerWeight,m+=(this.isEdge(t)?20:0)*this.currentStrategy.edgeWeight,m+=(this.isCenter(t)?15:0)*this.currentStrategy.centerWeight,m+=(this.isSafeMove(t,e)?30:0)*this.currentStrategy.safetyWeight,m+=c*10*this.currentStrategy.mobilityWeight,m+=y*6*this.currentStrategy.frontierWeight,m+=M*12*this.currentStrategy.stabilityWeight;const b=`${t.row}-${t.col}`,d=this.currentStrategy.learnedPatterns.get(b);return d&&(m+=d.value*d.confidence),m}analyzeSituation(t,e){return{mobility:t.mobility??0,frontier:t.frontier??0,stability:t.stability??0,cornerControl:t.cornerControl??0,edgeControl:t.edgeControl??0,centerControl:t.centerControl??0,safety:t.safety??0,opponentStyle:(e==null?void 0:e.style)||"balanced",opponentPreferences:(e==null?void 0:e.preferences)||[],opponentWeaknesses:(e==null?void 0:e.weaknesses)||[],timestamp:Date.now()}}determineAdaptationNeeds(t,e){const n={mobilityAdjustment:0,frontierAdjustment:0,stabilityAdjustment:0,cornerAdjustment:0,edgeAdjustment:0,centerAdjustment:0,safetyAdjustment:0,opponentSpecificAdjustments:[]};return t.mobility<-20?n.mobilityAdjustment=.3:t.mobility>20&&(n.mobilityAdjustment=-.2),t.frontier<-20&&(n.frontierAdjustment=.2),t.stability<-20&&(n.stabilityAdjustment=.3),t.cornerControl<-50&&(n.cornerAdjustment=.4),t.edgeControl<-10&&(n.edgeAdjustment=.15),t.centerControl<-10&&(n.centerAdjustment=.1),t.safety<-20&&(n.safetyAdjustment=.3),n.opponentSpecificAdjustments=this.getOpponentSpecificAdjustments(t),this.applyLearningAdjustments(n,e),n}applyAdaptations(t){const e=this.currentStrategy;e.mobilityWeight+=t.mobilityAdjustment,e.frontierWeight+=t.frontierAdjustment,e.stabilityWeight+=t.stabilityAdjustment,e.cornerWeight+=t.cornerAdjustment,e.edgeWeight+=t.edgeAdjustment,e.centerWeight+=t.centerAdjustment,e.safetyWeight+=t.safetyAdjustment;for(const n of t.opponentSpecificAdjustments)this.applyOpponentAdjustment(n);this.clampAndNormalize()}getOpponentSpecificAdjustments(t){const e=[];switch(t.opponentStyle){case"aggressive":e.push({type:"stability",value:.3,reason:"Opponent is aggressive"});break;case"defensive":e.push({type:"mobility",value:.3,reason:"Opponent is defensive"});break;case"balanced":e.push({type:"balanced",value:.1,reason:"Opponent is balanced"});break}for(const n of t.opponentWeaknesses)e.push({type:"exploit_weakness",value:.2,reason:`Exploit weakness: ${n}`});return e}applyLearningAdjustments(t,e){const n=this.analyzePositivePatterns(e),r=this.analyzeNegativePatterns(e);for(const s of n)t.mobilityAdjustment+=s.mobilityImpact*.1,t.stabilityAdjustment+=s.stabilityImpact*.1,t.cornerAdjustment+=s.cornerImpact*.1;for(const s of r)t.mobilityAdjustment-=s.mobilityImpact*.1,t.stabilityAdjustment-=s.stabilityImpact*.1,t.cornerAdjustment-=s.cornerImpact*.1}applyOpponentAdjustment(t){const e=this.currentStrategy;switch(t.type){case"mobility":e.mobilityWeight+=t.value;break;case"stability":e.stabilityWeight+=t.value;break;case"corner":e.cornerWeight+=t.value;break;case"balanced":e.mobilityWeight+=t.value*.5,e.stabilityWeight+=t.value*.5;break;case"exploit_weakness":e.mobilityWeight+=t.value*.5,e.safetyWeight+=t.value*.5;break}}clampAndNormalize(){const t=this.currentStrategy,e=r=>Math.max(0,Math.min(r,3));t.mobilityWeight=e(t.mobilityWeight),t.frontierWeight=e(t.frontierWeight),t.stabilityWeight=e(t.stabilityWeight),t.cornerWeight=e(t.cornerWeight),t.edgeWeight=e(t.edgeWeight),t.centerWeight=e(t.centerWeight),t.safetyWeight=e(t.safetyWeight);const n=t.mobilityWeight+t.frontierWeight+t.stabilityWeight+t.cornerWeight+t.edgeWeight+t.centerWeight+t.safetyWeight;n>0&&(t.mobilityWeight/=n,t.frontierWeight/=n,t.stabilityWeight/=n,t.cornerWeight/=n,t.edgeWeight/=n,t.centerWeight/=n,t.safetyWeight/=n)}storeStrategyChange(t,e){const n={timestamp:Date.now(),situation:t,adaptationNeeds:e,strategy:{...this.currentStrategy},effectiveness:0};this.strategyHistory.push(n),this.strategyHistory.length>100&&this.strategyHistory.shift()}getDefaultStrategy(){return{mobilityWeight:1,frontierWeight:1,stabilityWeight:1,cornerWeight:1,edgeWeight:1,centerWeight:1,safetyWeight:1,learnedPatterns:new Map,adaptationRules:new Map}}initializeAdaptationRules(){this.adaptationRules.set("mobility_low",{condition:t=>t.mobility<-20,action:t=>{t.mobilityWeight+=.3},description:"Mobility is low → focus on mobility"}),this.adaptationRules.set("stability_low",{condition:t=>t.stability<-20,action:t=>{t.stabilityWeight+=.3},description:"Stability is low → focus on stability"}),this.adaptationRules.set("corner_low",{condition:t=>t.cornerControl<-50,action:t=>{t.cornerWeight+=.4},description:"Corner control is low → focus on corners"})}analyzePositivePatterns(t){const e=[];for(const[n,r]of t.patterns)r.score>0&&e.push({key:n,mobilityImpact:.1,stabilityImpact:.1,cornerImpact:.1,confidence:.8});return e}analyzeNegativePatterns(t){const e=[];for(const n of t.mistakes)e.push({key:n,mobilityImpact:-.1,stabilityImpact:-.1,cornerImpact:-.1,confidence:.8});return e}isCorner(t){const{row:e,col:n}=t;return(e===0||e===7)&&(n===0||n===7)}isEdge(t){const{row:e,col:n}=t;return e===0||e===7||n===0||n===7}isCenter(t){const{row:e,col:n}=t;return e>=3&&e<=4&&n>=3&&n<=4}isSafeMove(t,e){return this.isCorner(t)?!0:!(this.isDangerousSquare(t,e)||this.isEdge(t)&&!this.isEdgeSafe(t,e))}isDangerousSquare(t,e){const{row:n,col:r}=t,s=[[1,1,0,0],[1,6,0,7],[6,1,7,0],[6,6,7,7]];for(const[o,c,l,a]of s)if(n===o&&r===c&&e[l][a]===null)return!0;const i=[{corner:[0,0],cells:[[0,1],[1,0]]},{corner:[0,7],cells:[[0,6],[1,7]]},{corner:[7,0],cells:[[6,0],[7,1]]},{corner:[7,7],cells:[[6,7],[7,6]]}];for(const o of i){const[c,l]=o.corner;if(e[c][l]===null){for(const[a,u]of o.cells)if(n===a&&r===u)return!0}}return!1}isEdgeSafe(t,e){const{row:n,col:r}=t;return!(n===0&&(r<=1&&e[0][0]===null||r>=6&&e[0][7]===null)||n===7&&(r<=1&&e[7][0]===null||r>=6&&e[7][7]===null)||r===0&&(n<=1&&e[0][0]===null||n>=6&&e[7][0]===null)||r===7&&(n<=1&&e[0][7]===null||n>=6&&e[7][7]===null))}simulateMove(t,e,n){if(t[e.row][e.col]!==null)return null;const r=t.map(c=>[...c]),s=n==="black"?"white":"black",i=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];let o=0;r[e.row][e.col]=n;for(const[c,l]of i){const a=[];let u=e.row+c,h=e.col+l;for(;u>=0&&u<8&&h>=0&&h<8&&r[u][h]===s;)a.push({row:u,col:h}),u+=c,h+=l;if(u>=0&&u<8&&h>=0&&h<8&&r[u][h]===n&&a.length)for(const y of a)r[y.row][y.col]=n,o++}return o?r:null}getValidMoves(t,e){const n=[];for(let r=0;r<8;r++)for(let s=0;s<8;s++)t[r][s]===null&&this.simulateMove(t,{row:r,col:s},e)&&n.push({row:r,col:s});return n}countFrontierDiscs(t,e){const n=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];let r=0;for(let s=0;s<8;s++)for(let i=0;i<8;i++)if(t[s][i]===e){let o=!1;for(const[c,l]of n){const a=s+c,u=i+l;if(a>=0&&a<8&&u>=0&&u<8&&t[a][u]===null){o=!0;break}}o&&r++}return r}getStrategyStats(){const t=this.strategyHistory.length||1;return{totalChanges:this.strategyHistory.length,averageEffectiveness:this.strategyHistory.reduce((e,n)=>e+n.effectiveness,0)/t,currentWeights:{...this.currentStrategy},adaptationRules:this.adaptationRules.size}}}const Kt=!1,Yt={level:18,enableLearning:!0,enableOpponentAnalysis:!0,enablePredictiveSearch:!0,enableAdaptiveStrategy:!0,enableAlphaBetaSearch:!0,search:{depthLimit:10,timeLimitMs:1200,aspirationWindow:64,useLMR:!0,useAspiration:!0},timeConfig:{totalTime:3e4,increment:1e3,minThinkTime:500,maxThinkTime:1e4}};class Qt extends ue{constructor(e={}){super();x(this,"name","Engine-Zenith");x(this,"version","1.1.0");x(this,"author","Zenith Research Team");x(this,"config");x(this,"evaluation");x(this,"strategy");x(this,"opponentAnalysis");x(this,"predictiveSearch");x(this,"adaptiveStrategy");x(this,"gameHistory",[]);x(this,"opponentProfile",null);x(this,"learningData",{wins:0,losses:0,totalMoves:0,positiveMoves:0,patterns:new Map,mistakes:[]});x(this,"isAnalyzing",!1);x(this,"lastAnalysisTime",0);x(this,"analysisCache",new Map);this.config={...Yt,...e},this.evaluation=new fe,this.strategy=new he,this.opponentAnalysis=new ge,this.predictiveSearch=new Me,this.adaptiveStrategy=new ve}async analyze(e){var r,s,i,o;const n=Date.now();if(this.isAnalyzing)return console.warn("Zenith: 이미 분석 중입니다. 요청을 무시합니다."),this.getFallbackResponse(n);this.isAnalyzing=!0;try{const{gameCore:c,timeLimit:l,skill:a}=e;this.validateRequest(e);const{board:u,currentPlayer:h}=e.gameCore,y=this.getValidMoves(u,h);if(!y||y.length===0){const p=Date.now()-n;return this.isAnalyzing=!1,{bestMove:void 0,evaluation:0,depth:0,nodes:0,timeUsed:p,pv:[]}}const M=this.resolveLevel(a,this.config.level),m=this.analyzeGamePhase(u);this.config.enableOpponentAnalysis&&(this.opponentProfile=this.opponentAnalysis.analyzeOpponent(this.gameHistory,e.opponentMoves||[]));const b=this.strategy.analyzePosition(u,h,m,this.opponentProfile),d=this.evaluation.evaluateBoard(u,h,m,b),E=typeof l=="number"?l:((r=this.config.search)==null?void 0:r.timeLimitMs)??1200,C=this.getEmptySquares(u);let _=null;if(this.config.enablePredictiveSearch&&E>=1200&&C<=56){const p=E>=5e3?C<=20?6:5:E>=2500?4:3;_=this.predictiveSearch.analyzeFutureScenarios(u,h,p)}const G=this.config.enableAdaptiveStrategy&&E>=800?this.adaptiveStrategy.adaptStrategy(b,this.opponentProfile,this.learningData):null;if(this.getEmptySquares(u)<=17){const p=Date.now(),w=this.solveEndgame(u,h,l),k=Date.now()-p;return this.updateGameHistory(e.gameCore,w.bestMove),{bestMove:w.bestMove,evaluation:w.evaluation,depth:w.depth,nodes:w.nodes,timeUsed:k,pv:w.pv}}const R=this.computeSearchBudget(M,l),A=this.runAlphaBetaBit(N(u),h,R),V=this.heuristicBestMove(u,h,d,b,_,G);this.config.enableLearning&&this.updateLearningData(V,d,b),this.updateGameHistory(e.gameCore,V);const $=Date.now()-n;this.lastAnalysisTime=$;const B=A?{score:A.score,depth:A.depth,nodes:A.nodes,confidence:this.estimateConfidence(A.depth,A.nodes),pv:A.pv}:{score:d.score,depth:d.depth??0,nodes:d.nodes??0,confidence:d.confidence??.5,pv:d.pv||[]};return{bestMove:V,evaluation:Number.isFinite(B.score)?B.score:0,depth:B.depth,nodes:B.nodes,timeUsed:$,pv:B.pv||[],stats:{gamePhase:m,strategicAnalysis:(b==null?void 0:b.summary)||"분석 실패",opponentProfile:((s=this.opponentProfile)==null?void 0:s.summary)||"프로필 없음",predictiveInsights:(_==null?void 0:_.summary)||"예측 없음",adaptiveStrategy:(G==null?void 0:G.name)||"적응 없음",confidence:B.confidence,learningProgress:this.getLearningProgress(),...A?{ttHits:A.ttHits,ttStores:A.ttStores}:{}}}}catch(c){console.error("Engine-Zenith analysis error:",c);const l=await this.getFallbackMove((i=e==null?void 0:e.gameCore)==null?void 0:i.board,(o=e==null?void 0:e.gameCore)==null?void 0:o.currentPlayer),a=Date.now()-n;return{bestMove:l,evaluation:0,depth:1,nodes:0,timeUsed:a,pv:[],stats:{error:c instanceof Error?c.message:"Unknown error",fallback:!0}}}finally{this.isAnalyzing=!1}}runAlphaBetaBit(e,n,r){const i=Date.now()+Math.max(100,Math.floor(r.timeLimitMs));let o=0,c=0,l=0;const a=new Map,u=new Array(128),h=new Array(128),y=new Array(64).fill(0),M=(g,p)=>It(g,p),m=(g,p,w,k)=>{const D=P=>{let O=0;w&&P.row===w.row&&P.col===w.col&&(O+=1e4);const W=u[k],F=h[k];W&&P.row===W.row&&P.col===W.col?O+=5e3:F&&P.row===F.row&&P.col===F.col&&(O+=3e3);const q=P.row*8+P.col;O+=y[q]|0,O+=this.isCorner(P)?200:0;const U=P.row===0||P.row===7||P.col===0||P.col===7?1:0;return O+=U?50:0,O},H=g.slice();return H.sort((P,O)=>D(O)-D(P)),H},b=(g,p)=>{const w=p==="black"?g._bp:g._wp,k=p==="black"?g._wp:g._bp,D=Z(w)-Z(k),H=st(p==="black"?1:2,g),P=st(p==="black"?2:1,g),O=Number(Z(H)),W=Number(Z(P)),F=O+W,q=F>0?(O-W)/F*100:0,U=[0,7,56,63];let at=0,X=0;for(const et of U){const j=1n<<BigInt(et);(w&j)!==0n?at++:(k&j)!==0n&&X++}const ot=at-X,Q=Ht(g),Wt=Q>=44?2:Q>=28?1.5:Q>=12?1.2:1,ut=Q<=20?1.5:1,ct=D*ut+q*.5+ot*50,K=Wt*ct;return Math.max(-999,Math.min(999,K))},d=4,E=g=>(g.row===0||g.row===7)&&(g.col===0||g.col===7),C=(g,p,w)=>{const k=Dt(p,w),D=1n<<BigInt(k);return((BigInt(g._bp)|BigInt(g._wp))&D)===0n},_=g=>g.row===1&&g.col===1||g.row===1&&g.col===6||g.row===6&&g.col===1||g.row===6&&g.col===6,v=g=>g.row===0&&g.col===1||g.row===1&&g.col===0||g.row===0&&g.col===6||g.row===1&&g.col===7||g.row===7&&g.col===1||g.row===6&&g.col===0||g.row===7&&g.col===6||g.row===6&&g.col===7,S=(g,p)=>{if(E(p))return!0;if(_(p)){const w=p.row===1&&p.col===1?[0,0]:p.row===1&&p.col===6?[0,7]:p.row===6&&p.col===1?[7,0]:[7,7];return C(g,w[0],w[1])}if(v(p)){const w={"0,1":[0,0],"1,0":[0,0],"0,6":[0,7],"1,7":[0,7],"7,1":[7,0],"6,0":[7,0],"7,6":[7,7],"6,7":[7,7]},k=`${p.row},${p.col}`,D=w[k];if(D)return C(g,D[0],D[1])}return(p.row===0||p.row===7||p.col===0||p.col===7)&&(p.row===0&&(p.col<=1||p.col>=6)||p.row===7&&(p.col<=1||p.col>=6)||p.col===0&&(p.row<=1||p.row>=6)||p.col===7&&(p.row<=1||p.row>=6))},G=(g,p,w,k,D,H)=>{const P=b(g,p);if(P>=k)return k;if(w<P&&(w=P),D<=0)return P;const O=ft(st(p==="black"?1:2,g)).filter(F=>S(g,F));if(O.length===0)return P;const W=p==="black"?"white":"black";for(const F of O){const q=lt(g,F.row,F.col,p);if(!q)continue;const U=-G(g,W,-k,-w,D-1);if(gt(g,q),U>=k)return k;U>w&&(w=U)}return w},z=(g,p,w,k,D,H,P)=>{if(Date.now()>i)throw new Error("ab_timeout");const O=M(g,p),W=a.get(O);if(W&&W.depth>=w&&(c++,W.flag==="exact"||(W.flag==="lower"?k=Math.max(k,W.value):W.flag==="upper"&&(D=Math.min(D,W.value)),k>=D)))return W.value;const F=ft(st(p==="black"?1:2,g)),q=p==="black"?"white":"black",U=b(g,p);if(w<=2&&U>=D)return U;if(w===0||F.length===0){if(F.length===0){if(ft(st(q==="black"?1:2,g)).length===0)return p==="black"?Z(g._bp)-Z(g._wp):Z(g._wp)-Z(g._bp);const I=[];return-z(g,q,w,-D,-k,I,P+1)}return G(g,p,k,D,d)}let at,X=-1/0;const ot=W==null?void 0:W.best,Q=m(F,g,ot,P),Wt=k;for(let tt=0;tt<Q.length;tt++){const I=Q[tt],ct=lt(g,I.row,I.col,p);if(!ct)continue;o++;const K=[];let et=w-1,j;const be=ot&&I.row===ot.row&&I.col===ot.col;if(w===1&&U+2<=k&&!this.isCorner(I)){gt(g,ct);continue}if(tt===0)if(r.useLMR&&w>=3&&tt>=3&&!be){const Gt=Math.max(1,et-1);j=-z(g,q,Gt,-D,-k,K,P+1),j>k&&(j=-z(g,q,et,-D,-k,K,P+1))}else j=-z(g,q,et,-D,-k,K,P+1);else j=-z(g,q,et,-(k+1),-k,K,P+1),j>k&&j<D&&(j=-z(g,q,et,-D,-k,K,P+1));if(gt(g,ct),j>X&&(X=j,at=I,H.length=0,H.push(I,...K)),X>k&&(k=X),k>=D){const Gt=I.row*8+I.col;y[Gt]+=w*w;const Vt=u[P];(!Vt||Vt.row!==I.row||Vt.col!==I.col)&&(h[P]=u[P],u[P]=I);break}}let ut="exact";return X<=Wt?ut="upper":X>=D&&(ut="lower"),a.set(O,{depth:w,value:X,flag:ut,best:at}),l++,l%8192===0&&a.size>15e4&&a.clear(),X};let R,A=-1/0,V=0,$=[],B=0;for(let g=4;g<=Math.max(4,r.depthLimit);g++){const p=[];try{if(r.useAspiration&&g>4){let w=Math.max(4,r.aspirationWindow??16),k=B-w,D=B+w;for(let H=0;H<3;H++){const P=z(e,n,g,k,D,p,0);if(P<=k)k-=w,w*=2;else if(P>=D)D+=w,w*=2;else{B=P;break}}A=B}else{const w=z(e,n,g,-1/0,1/0,p,0);A=w,B=w}R=p[0],V=g,$=p.slice()}catch(w){if(w.message==="ab_timeout")break;throw w}}return{bestMove:R,score:A,depth:V,nodes:o,pv:$,ttHits:c,ttStores:l}}solveEndgame(e,n,r){const s=n,i=this.getEmptySquares(e),o=typeof r=="number"&&r>0?Date.now()+Math.max(100,Math.floor(r*.95)):Number.POSITIVE_INFINITY;let c=0;const l=new Map,a=(d,E)=>{let C=E==="black"?"b|":"w|";for(let _=0;_<8;_++)for(let v=0;v<8;v++){const S=d[_][v];C+=S===null?"0":S==="black"?"1":"2"}return C},u=(d,E)=>d.slice().sort((C,_)=>{const v=this.isCorner(C)?1:0,S=this.isCorner(_)?1:0;if(v!==S)return S-v;const G=C.row===0||C.row===7||C.col===0||C.col===7?1:0;return(_.row===0||_.row===7||_.col===0||_.col===7?1:0)-G}),h=d=>{const E=this.calculateScore(d);return s==="black"?E.black-E.white:E.white-E.black},y=(d,E,C,_,v,S)=>{if(Date.now()>o)throw new Error("endgame_timeout");const G=a(d,E),z=l.get(G);if(z&&z.depth>=C&&(z.flag==="exact"||(z.flag==="lower"?_=Math.max(_,z.value):z.flag==="upper"&&(v=Math.min(v,z.value)),_>=v)))return z.value;const R=this.getValidMoves(d,E),A=E==="black"?"white":"black",V=this.getValidMoves(d,A),$=R.length===0,B=V.length===0;if($&&B||C===0){const k=h(d);return l.set(G,{depth:C,value:k,flag:"exact"}),k}let g,p=-1/0;if($){const k=[];p=-y(d,A,C,-v,-_,k)}else{const k=u(R);for(const D of k){const H=this.simulateMove(d,D,E);if(!H)continue;c++;const P=[],O=-y(H,A,C-1,-v,-_,P);if(O>p&&(p=O,g=D,S.length=0,S.push(D,...P)),_=Math.max(_,p),_>=v)break}}let w="exact";return p<=_?w="upper":p>=v&&(w="lower"),l.set(G,{depth:C,value:p,best:g,flag:w}),p},M=[];let m=0;try{m=y(e,n,i,-1/0,1/0,M)}catch(d){if(d.message!=="endgame_timeout")throw d;if(M.length===0){const E=this.calculateScore(e);m=s==="black"?E.black-E.white:E.white-E.black}}return{bestMove:M[0],evaluation:m,depth:i,nodes:c,pv:M}}evalForSearch(e,n){const r=this.getEmptySquares(e),s=r>=45?"opening":r>=20?"midgame":r>=10?"late_midgame":"endgame",i=this.strategy.analyzePosition(e,n,s,this.opponentProfile),{score:o}=this.evaluation.evaluateBoard(e,n,s,i);return o}computeSearchBudget(e,n){const r=this.config.search||{},s=this.config.timeConfig,i=(M,m,b)=>Math.max(m,Math.min(b,M)),o=r.depthLimit??Math.round(10+Math.min(10,Math.max(1,e))),c=i(o,12,20),l=typeof n=="number"?n:r.timeLimitMs??1200,a=i(Math.floor(l*.95),s.minThinkTime,s.maxThinkTime),u=r.useLMR??e>=8,h=r.useAspiration??e>=6,y=r.aspirationWindow??(e>=14?48:64);return{depthLimit:c,timeLimitMs:a,aspirationWindow:y,useLMR:u,useAspiration:h}}estimateConfidence(e,n){const r=Math.min(14,Math.max(3,e)),s=Math.log10(Math.max(1e3,n)),i=.45+(r-3)*.03+(s-3)*.025;return Math.max(.55,Math.min(.98,i))}heuristicBestMove(e,n,r,s,i,o){const c=this.getValidMoves(e,n);return c.length===0?void 0:c.map(a=>({move:a,score:this.calculateMoveScore(a,e,n,r,s,i,o)})).sort((a,u)=>u.score-a.score)[0].move}calculateMoveScore(e,n,r,s,i,o,c){var M,m;const l=(s.score??0)*.15,a=((M=i.getMoveValue)==null?void 0:M.call(i,e))??0,u=(o==null?void 0:o.getMoveValue(e))??0,h=((m=c==null?void 0:c.getMoveValue)==null?void 0:m.call(c,e))??0,y=this.assessMoveSafety(e,n,r)*.15;return l+a*.35+u*.25+h*.15+y}assessMoveSafety(e,n,r){return this.isDangerousSquare(e,n)?-100:this.isCorner(e)?100:this.isEdgeSafe(e,n)?50:0}isDangerousSquare(e,n){const{row:r,col:s}=e,o=this.getEmptySquares(n)>30,c=[[1,1],[1,6],[6,1],[6,6]];for(const[a,u]of c)if(r===a&&s===u){const h=a===1?0:7,y=u===1?0:7;if(n[h][y]===null)return o||this.countOpponentCorners(n)>0,!0}const l=[[[0,0],[0,1],[1,0]],[[0,7],[0,6],[1,7]],[[7,0],[6,0],[7,1]],[[7,7],[6,7],[7,6]]];for(const a of l){const[u,h,y]=a;if(n[u[0]][u[1]]===null&&(r===h[0]&&s===h[1]||r===y[0]&&s===y[1]))return!!(o||this.countOpponentCorners(n)>=2)}return!1}countOpponentCorners(e){const n=[[0,0],[0,7],[7,0],[7,7]];let r=0;for(const[s,i]of n)e[s][i]!==null&&r++;return r}isCorner(e){const{row:n,col:r}=e;return(n===0||n===7)&&(r===0||r===7)}isEdgeSafe(e,n){const{row:r,col:s}=e;if(!(r===0||r===7||s===0||s===7))return!1;const o=[];r===0&&(s===1&&o.push([0,0]),s===6&&o.push([0,7])),r===7&&(s===1&&o.push([7,0]),s===6&&o.push([7,7])),s===0&&(r===1&&o.push([0,0]),r===6&&o.push([7,0])),s===7&&(r===1&&o.push([0,7]),r===6&&o.push([7,7]));for(const[c,l]of o)if(n[c][l]===null)return!1;return!0}async getFallbackMove(e,n){const r=this.getValidMoves(e,n);if(r.length===0)return;const s=r.filter(c=>this.isCorner(c));if(s.length)return s[0];const i=r.filter(c=>this.isEdgeSafe(c,e));if(i.length)return i[0];const o=r.filter(c=>!this.isDangerousSquare(c,e));return o.length?o[0]:r[0]}analyzeGamePhase(e){const n=this.getEmptySquares(e);return n>=45?"opening":n>=20?"midgame":"endgame"}resolveLevel(e,n){return typeof e=="number"&&e>=1?Math.max(1,Math.min(20,Math.floor(e/5)+10)):Math.max(1,Math.min(20,n??16))}updateLearningData(e,n,r){if(!e)return;const s=this.extractMovePattern(e,n,r);this.learningData.patterns.set(s.key,s),this.learningData.totalMoves++,n.score>0&&this.learningData.positiveMoves++}extractMovePattern(e,n,r){var s;return{key:`${e.row}-${e.col}`,move:e,score:n.score,strategicValue:((s=r.getMoveValue)==null?void 0:s.call(r,e))??0,timestamp:Date.now()}}updateGameHistory(e,n){e&&(this.gameHistory.push({board:e.board,move:n,timestamp:Date.now()}),this.gameHistory.length>50&&this.gameHistory.shift())}getLearningProgress(){const e=this.learningData.wins+this.learningData.losses;return{totalMoves:this.learningData.totalMoves,positiveMoves:this.learningData.positiveMoves,patternsLearned:this.learningData.patterns.size,winRate:e?this.learningData.wins/e:0}}updateConfig(e){this.config={...this.config,...e}}clearState(){this.gameHistory=[],this.opponentProfile=null,this.learningData={wins:0,losses:0,totalMoves:0,positiveMoves:0,patterns:new Map,mistakes:[]}}getStats(){return{name:this.name,version:this.version,config:this.config,learningProgress:this.getLearningProgress(),gameHistory:this.gameHistory.length,opponentProfile:this.opponentProfile}}getFallbackResponse(e){return{bestMove:void 0,evaluation:0,depth:0,nodes:0,timeUsed:Date.now()-e,pv:[],stats:{error:"분석 중복 요청",fallback:!0}}}validateBoard(e){if(!e||!Array.isArray(e)||e.length!==8)return!1;for(let n=0;n<8;n++){if(!Array.isArray(e[n])||e[n].length!==8)return!1;for(let r=0;r<8;r++){const s=e[n][r];if(s!==null&&s!=="black"&&s!=="white")return!1}}return!0}cleanupCache(){this.analysisCache.size>1e3&&Array.from(this.analysisCache.entries()).slice(0,200).forEach(([n])=>{this.analysisCache.delete(n)})}getCacheKey(e,n){let r="";for(let s=0;s<8;s++)for(let i=0;i<8;i++){const o=e[s][i];r+=o===null?"0":o==="black"?"1":"2"}return`${n}_${r}`}}const yt=new Qt;async function Se(f,t,e){if(e.rootMove){const{row:s,col:i}=e.rootMove;if(f.board[s][i]!==null)return{bestMove:e.rootMove,evaluation:-1/0,nodes:1,pv:[e.rootMove]};const o={...f},c=pt(o,e.rootMove);if(!c.success)return{bestMove:e.rootMove,evaluation:-1/0,nodes:1,pv:[e.rootMove]};const l={gameCore:c.newGameCore,timeLimit:e.timeLimit,skill:18},a=await yt.analyze(l);return{bestMove:e.rootMove,evaluation:a.evaluation,nodes:a.nodes,pv:[e.rootMove,...a.pv||[]]}}const n={gameCore:f,timeLimit:e.timeLimit,skill:18},r=await yt.analyze(n);return{bestMove:r.bestMove,evaluation:r.evaluation,nodes:r.nodes,pv:r.pv?[...r.pv]:void 0}}T.DEFAULT_ZENITH_CONFIG=Yt,T.EngineZenith=Qt,T.alphaBetaSearch=Se,T.default=yt,T.engineZenith=yt,Object.defineProperties(T,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
