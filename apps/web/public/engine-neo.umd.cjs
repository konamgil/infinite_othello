(function(f,M){typeof exports=="object"&&typeof module<"u"?M(exports):typeof define=="function"&&define.amd?define(["exports"],M):(f=typeof globalThis<"u"?globalThis:f||self,M(f.EngineNeo={}))})(this,function(f){"use strict";var te=Object.defineProperty;var ee=(f,M,N)=>M in f?te(f,M,{enumerable:!0,configurable:!0,writable:!0,value:N}):f[M]=N;var h=(f,M,N)=>ee(f,typeof M!="symbol"?M+"":M,N);class M{constructor(t=2e5){h(this,"table",new Map);h(this,"currentAge",0);h(this,"maxSize");this.maxSize=t}getAge(){return this.currentAge}bumpAge(){this.currentAge=this.currentAge+1|0}get(t){return this.table.get(t)}set(t,i){this.table.size>=this.maxSize&&this.evictOldEntries(),this.table.set(t,{...i,age:this.currentAge})}evictOldEntries(){const t=Math.max(1,Math.floor(this.maxSize*.02));let i=0;for(const[e,n]of this.table.entries())if(n.age!==this.currentAge&&(this.table.delete(e),i++,i>=t))break;if(this.table.size>=this.maxSize){let e=0;const n=64;for(const o of this.table.keys())if(this.table.delete(o),e++,e>=n)break}}clear(){this.table.clear(),this.currentAge=0}getStats(){return{size:this.table.size,maxSize:this.maxSize,age:this.currentAge,fillRatio:this.table.size/this.maxSize}}isUsable(t,i){return t!==void 0&&t.depth>=i}getBestMove(t){return t==null?void 0:t.bestMove}providesScoreCutoff(t,i,e,n){if(!this.isUsable(t,n))return{cutoff:!1};const{flag:o,score:r}=t;if(o===0)return{cutoff:!0,score:r};if(o===1&&r>=e)return{cutoff:!0,score:r};if(o===2&&r<=i)return{cutoff:!0,score:r};let c=i,l=e;return o===1?c=Math.max(i,r):o===2&&(l=Math.min(e,r)),c>=l?{cutoff:!0,score:r}:{cutoff:!1,newAlpha:c!==i?c:void 0,newBeta:l!==e?l:void 0}}createEntry(t,i,e,n,o){let r;return i<=n?r=2:i>=o?r=1:r=0,{depth:t,flag:r,score:i,bestMove:e,age:this.currentAge}}}function N(s){return s>=45?{mobility:28,pmob:12,stability:6,frontier:10,corner:35,x:18,c:10,parity:0,edge:4,edgeOcc:-4}:s>=20?{mobility:24,pmob:16,stability:10,frontier:16,corner:34,x:22,c:14,parity:6,edge:8,edgeOcc:-8}:{mobility:8,pmob:6,stability:22,frontier:8,corner:40,x:20,c:12,parity:18,edge:12,edgeOcc:6}}const L=[[120,-20,20,5,5,20,-20,120],[-20,-40,-5,-5,-5,-5,-40,-20],[20,-5,15,3,3,15,-5,20],[5,-5,3,3,3,3,-5,5],[5,-5,3,3,3,3,-5,5],[20,-5,15,3,3,15,-5,20],[-20,-40,-5,-5,-5,-5,-40,-20],[120,-20,20,5,5,20,-20,120]],xt=[{corner:[0,0],x:[1,1],c:[[0,1],[1,0]]},{corner:[0,7],x:[1,6],c:[[0,6],[1,7]]},{corner:[7,0],x:[6,1],c:[[6,0],[7,1]]},{corner:[7,7],x:[6,6],c:[[6,7],[7,6]]}],q=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]],$=0x0101010101010101n,V=0x8080808080808080n,B=0xffffffffffffffffn,O=B^$,P=B^V;function Y(s){return(s&P)<<1n}function j(s){return(s&O)>>1n}function X(s){return s<<8n}function J(s){return s>>8n}function Z(s){return(s&P)<<9n}function Q(s){return(s&O)<<7n}function tt(s){return(s&P)>>7n}function et(s){return(s&O)>>9n}const Ht=[Y,j,X,J,Z,Q,tt,et];function it(s){let t=0n,i=BigInt(s);for(;i>1n;)i>>=1n,t++;return Number(t)}function nt(s,t){return(7-s)*8+t}function st(s){if(s<0||s>63)throw new Error("Invalid bit index: "+s);const i=7-(s/8|0),e=s%8;return[i,e]}function ot(s){const t=[];let i=BigInt(s);for(;i;){const e=i&-i,n=it(e),[o,r]=st(n);t.push({row:o,col:r}),i^=e}return t}function rt(s){return s&&typeof s.length=="number"&&typeof s.subarray=="function"}function Lt(s){const t=new Uint8Array(64);for(let i=0;i<8;i++)for(let e=0;e<8;e++){const n=s[i][e];t[i*8+e]=n==="black"?1:n==="white"?2:0}return t}function Ct(s){let t=0n,i=0n;for(let e=0;e<64;e++){const n=s[e]|0;if(n===0)continue;const o=e/8|0,r=e%8,c=nt(o,r),l=1n<<BigInt(c);n===1?t|=l:n===2&&(i|=l)}return{bp:t,wp:i}}function D(s){let t;if(rt(s)?t=s:Array.isArray(s)&&Array.isArray(s[0])?t=Lt(s):Array.isArray(s)?t=Uint8Array.from(s):s&&s.cells&&rt(s.cells)?t=s.cells:t=new Uint8Array(64),t._bp===void 0||t._wp===void 0){const{bp:i,wp:e}=Ct(t);t._bp=i,t._wp=e}return t}function Bt(s,t,i){let e=i(s)&t;return e|=i(e)&t,e|=i(e)&t,e|=i(e)&t,e|=i(e)&t,e|=i(e)&t,i(e)}function ct(s,t){const i=D(t),e=s===1?i._bp:i._wp,n=s===1?i._wp:i._bp,o=~(e|n)&B;let r=0n;for(const c of Ht)r|=Bt(e,n,c);return r&o}function Ot(s){return s==="black"?1:2}function lt(s,t){const i=Ot(s),e=ct(i,t);return ot(e)}function Pt(s){const t=new Uint8Array(64);for(let i=0;i<8;i++)for(let e=0;e<8;e++){const n=s[i][e],o=i*8+e;n==="black"?t[o]=1:n==="white"?t[o]=2:t[o]=0}return t}function C(s,t){const i=D(Pt(s));return lt(t,i)}function at(s,t){return C(s,t).length}function ft(s,t){const i=t==="black"?"white":"black";let e=0;for(let n=0;n<8;n++)for(let o=0;o<8;o++){if(s[n][o]!==null)continue;let r=!1;for(const[c,l]of q){const a=n+c,u=o+l;if(a>=0&&a<8&&u>=0&&u<8&&s[a][u]===i){r=!0;break}}r&&e++}return e}function Rt(s,t,i){const e=at(s,t),n=at(s,i),o=ft(s,t),r=ft(s,i);return{currentMobility:e,potentialMobility:o,mobilityDiff:e-n,potentialMobilityDiff:o-r}}function Dt(s){const{row:t,col:i}=s;return(t===0||t===7)&&(i===0||i===7)}function ut(s){let t=0;for(let i=0;i<8;i++)for(let e=0;e<8;e++)s[i][e]===null&&t++;return t}function zt(s){let t=0,i=0;for(let e=0;e<8;e++)for(let n=0;n<8;n++){const o=s[e][n];o==="black"?t++:o==="white"&&i++}return{black:t,white:i}}class z{constructor(){h(this,"moves",new Map);h(this,"maxKillersPerPly",2)}addKiller(t,i){this.moves.has(t)||this.moves.set(t,[]);const e=this.moves.get(t),n=e.findIndex(o=>o.row===i.row&&o.col===i.col);n!==-1&&e.splice(n,1),e.unshift(i),e.length>this.maxKillersPerPly&&e.pop()}getKillers(t){return this.moves.get(t)||[]}getKillerPriority(t,i){const e=this.getKillers(i);for(let n=0;n<e.length;n++){const o=e[n];if(o.row===t.row&&o.col===t.col)return 2-n}return 0}clear(){this.moves.clear()}}class G{constructor(){h(this,"history",new Map)}getKey(t,i){return`${t.row},${t.col}|${i}`}updateHistory(t,i,e){const n=this.getKey(t,i),o=e*e,r=this.history.get(n)||0;this.history.set(n,r+o)}getHistoryScore(t,i){const e=this.getKey(t,i);return this.history.get(e)||0}clear(){this.history.clear()}ageHistory(t=.9){for(const[i,e]of this.history.entries())this.history.set(i,Math.floor(e*t))}}function Gt(s,t){const i=s.map(e=>({move:e,score:Wt(e,t)}));return i.sort((e,n)=>n.score-e.score),i.map(e=>e.move)}function Wt(s,t){const{ply:i,player:e,killers:n,history:o,ttBestMove:r}=t;let c=0;r&&r.row===s.row&&r.col===s.col&&(c+=1e4),Dt(s)&&(c+=5e3),c+=L[s.row][s.col];const l=n.getKillerPriority(s,i);l>0&&(c+=1e3*l);const a=o.getHistoryScore(s,e);c+=a/10;const u=Math.abs(s.row-3.5)+Math.abs(s.col-3.5);return c+=(7-u)*2,c}function ht(s,t){const i=new Set,e=[{pos:[0,0],dirs:[[0,1],[1,0]]},{pos:[0,7],dirs:[[0,-1],[1,0]]},{pos:[7,0],dirs:[[-1,0],[0,1]]},{pos:[7,7],dirs:[[-1,0],[0,-1]]}];for(const{pos:[n,o],dirs:r}of e)if(s[n][o]===t){i.add(`${n},${o}`);for(const[l,a]of r){let u=n+l,m=o+a;for(;u>=0&&u<8&&m>=0&&m<8&&s[u][m]===t;)i.add(`${u},${m}`),u+=l,m+=a}}return i.size}function mt(s,t){const i=new Set;function e(o,r,c,l){for(;o>=0&&o<8&&r>=0&&r<8&&s[o][r]===t;)i.add(`${o},${r}`),o+=c,r+=l}const n=[[0,0],[0,7],[7,0],[7,7]];for(const[o,r]of n)s[o][r]===t&&(o===0&&r===0?(e(o,r,0,1),e(o,r,1,0)):o===0&&r===7?(e(o,r,0,-1),e(o,r,1,0)):o===7&&r===0?(e(o,r,-1,0),e(o,r,0,1)):o===7&&r===7&&(e(o,r,-1,0),e(o,r,0,-1)));return i.size}function gt(s,t){let i=0;for(let e=0;e<8;e++)s[0][e]===t&&i++,s[7][e]===t&&i++;for(let e=1;e<7;e++)s[e][0]===t&&i++,s[e][7]===t&&i++;return i}function Mt(s,t){let i=0;for(let e=0;e<8;e++)for(let n=0;n<8;n++){if(s[e][n]!==t)continue;let o=!1;for(const[r,c]of q){const l=e+r,a=n+c;if(l<0||l>=8||a<0||a>=8||s[l][a]===null){o=!0;break}}o&&i++}return i}function R(s,t,i=!1){if(i){const T=zt(s),E=T[t],H=t==="black"?T.white:T.black;return E-H}const e=t==="black"?"white":"black",n=ut(s),o=N(n);let r=0,c=0;for(let T=0;T<8;T++)for(let E=0;E<8;E++){const H=s[T][E];H===t?c+=L[T][E]:H===e&&(c-=L[T][E])}const l=Rt(s,t,e),a=o.mobility*l.mobilityDiff,u=o.pmob*l.potentialMobilityDiff,m=ht(s,t),S=ht(s,e),k=o.stability*(m-S),v=Mt(s,t),y=Mt(s,e),A=o.frontier*(y-v),I=n%2===(t==="black"?1:0)?o.parity:-o.parity,g=mt(s,t),_=mt(s,e),w=o.edge*(g-_),d=gt(s,t),p=gt(s,e),At=o.edgeOcc*(d-p);let x=0,F=0,K=0;for(const{corner:T,x:E,c:H}of xt){const[Yt,jt]=T,[Xt,Jt]=E,It=s[Yt][jt];if(It===t)x+=o.corner;else if(It===e)x-=o.corner;else{const Nt=s[Xt][Jt];Nt===t?F-=o.x:Nt===e&&(F+=o.x);for(const[Zt,Qt]of H){const _t=s[Zt][Qt];_t===t?K-=o.c:_t===e&&(K+=o.c)}}}return r=c+a+u+k+A+I+w+At+x+F+K,r}function Ut(s,t){const i=t==="black"?"white":"black";let e=0;for(let o=0;o<8;o++)for(let r=0;r<8;r++){const c=s[o][r];c===t?e+=L[o][r]:c===i&&(e-=L[o][r])}const n=[[0,0],[0,7],[7,0],[7,7]];for(const[o,r]of n){const c=s[o][r];c===t?e+=100:c===i&&(e-=100)}return e}function vt(s,t=12){return ut(s)<=t}const b=[];function Ft(){for(let s=0;s<=60;s++){b[s]=[];for(let t=0;t<=60;t++)b[s][t]={depth:0,selectivity:5}}for(let s=0;s<=60;s++)for(let t=0;t<=60;t++){if(s<=0){b[s][t]={depth:0,selectivity:5};continue}if(s<=10){b[s][t]={depth:t<=2*s?t:s,selectivity:5};continue}const i=[{lim:12,sel:[[21,5],[24,3],[99,0]]},{lim:18,sel:[[21,5],[24,3],[27,1],[99,0]]},{lim:24,sel:[[24,5],[27,4],[30,2],[33,0],[99,0]]},{lim:33,sel:[[30,5],[33,4],[36,2],[39,0],[99,0]]},{lim:35,sel:[[30,5],[33,4],[36,3],[39,1],[99,0]]}];let e=!1;for(const n of i)if(s<=n.lim){let o=0,r={depth:t,selectivity:0};for(const[c,l]of n.sel)if(o=l,t<=c){r={depth:t,selectivity:o};break}b[s][t]=r,e=!0;break}if(!e){let n=0;t<=s-6?n=5:t<=s-3?n=4:t<=s?n=3:t<=s+3?n=2:t<=s+6?n=1:n=0,b[s][t]={depth:t<=s+9?t:s,selectivity:n}}}}Ft();function dt(s,t){const i=Math.max(0,Math.min(60,s)),e=Math.max(0,Math.min(60,t));return b[i][e]}function St(s){const e=(5-Math.max(0,Math.min(5,s)))/5;return{lmrBase:.75+1.75*e,lmpBonus:Math.round(12*e),futMul:1+1*e,razorMul:1+.8*e,useNWS:e>.15}}var Tt=(s=>(s[s.BEGINNER=8]="BEGINNER",s[s.EASY=12]="EASY",s[s.MEDIUM=18]="MEDIUM",s[s.HARD=24]="HARD",s[s.EXPERT=33]="EXPERT",s[s.MASTER=40]="MASTER",s[s.GRANDMASTER=50]="GRANDMASTER",s))(Tt||{});function Kt(s){switch(s.toLowerCase()){case"beginner":return 8;case"easy":return 12;case"medium":return 18;case"hard":return 24;case"expert":return 33;case"master":return 40;case"grandmaster":return 50;default:return 18}}const qt={NWS:Array.from({length:61},(s,t)=>t<4?99:t<=8?8:t<=24?26+Math.floor((t-8)*1.2):Math.min(64,40+Math.floor((t-24)*1))),PVS:Array.from({length:61},(s,t)=>t<4?99:t<=8?0:t<=24?12+Math.floor((t-8)*1.2):Math.min(62,32+Math.floor((t-24)*1)))},pt={LMP_TABLE:[0,0,3,5,7,9,12],FUTILITY_MARGINS:[0,120,200,280],RAZOR_MARGINS:[0,300,500],NULL_MOVE_R:2,NULL_MOVE_MIN_DEPTH:2},yt=20;class $t{constructor(){h(this,"tt");h(this,"killers");h(this,"history");h(this,"nodes",0);h(this,"ttHits",0);h(this,"ttStores",0);h(this,"startTime",0);h(this,"timeLimit",1/0);this.tt=new M(2e5),this.killers=new z,this.history=new G}search(t,i,e){this.initializeSearch(e);const n=this.countEmptySquares(t),o=dt(e.level,n),r=St(o.selectivity);let c,l=-1/0,a=[];for(let u=1;u<=o.depth&&!this.shouldStop();u++){const m=this.pvs(t,i,u,-1/0,1/0,0,!0,r);this.shouldStop()||(c=m.move,l=m.score,a=m.pv)}return{bestMove:c,score:l,depth:o.depth,nodes:this.nodes,time:Date.now()-this.startTime,pv:a,ttHits:this.ttHits,ttStores:this.ttStores}}pvs(t,i,e,n,o,r,c,l){if(this.nodes++,e<=0)return{score:this.quiescenceSearch(t,i,n,o,r),move:void 0,pv:[]};if(this.shouldStop())return{score:R(t,i),move:void 0,pv:[]};const a=this.generateBoardKey(t,i),u=this.tt.get(a);let m;if(u&&this.tt.isUsable(u,e)){this.ttHits++;const g=this.tt.providesScoreCutoff(u,n,o,e);if(g.cutoff&&g.score!==void 0)return{score:g.score,move:u.bestMove,pv:[]};g.newAlpha!==void 0&&(n=g.newAlpha),g.newBeta!==void 0&&(o=g.newBeta),m=u.bestMove}const S=C(t,i);if(S.length===0){const g=i==="black"?"white":"black";if(C(t,g).length===0)return{score:this.evaluateGameEnd(t,i),move:void 0,pv:[]};{const w=this.pvs(t,g,e-1,-o,-n,r+1,c,l);return{score:-w.score,move:void 0,pv:w.pv}}}const k=Gt(S,{ply:r,player:i,killers:this.killers,history:this.history,ttBestMove:m});let v,y=-1/0,A=[],I=0;for(const g of k){if(this.shouldPruneMove(I,e,n,o,l))break;const _=this.makeMove(t,g,i),w=i==="black"?"white":"black";let d;if(I===0){const p=this.pvs(_,w,e-1,-o,-n,r+1,c,l);d=-p.score,d>n&&(A=[g,...p.pv])}else{let p=0;if(this.shouldReduceMove(I,e,g,l)&&(p=Math.floor(l.lmrBase+Math.log(e)*Math.log(I)/3),p=Math.max(0,Math.min(p,e-2))),d=-this.pvs(_,w,e-1-p,-n-1,-n,r+1,!1,l).score,d>n&&d<o&&(p>0||!c)){const x=this.pvs(_,w,e-1,-o,-n,r+1,c,l);d=-x.score,d>n&&(A=[g,...x.pv])}}if(d>y&&(y=d,v=g),d>n&&(n=d,A.length||(A=[g])),n>=o){this.killers.addKiller(r,g),this.history.updateHistory(g,i,e);break}I++}if(v){const g=this.tt.createEntry(e,y,v,n,o);this.tt.set(a,g),this.ttStores++}return{score:y,move:v,pv:A}}quiescenceSearch(t,i,e,n,o){this.nodes++;const r=R(t,i);if(r>=n)return n;r>e&&(e=r);const c=C(t,i);if(c.length===0)return r;const l=this.filterTacticalMoves(c,t);for(const a of l){const u=this.makeMove(t,a,i),m=i==="black"?"white":"black",S=-this.quiescenceSearch(u,m,-n,-e,o+1);if(S>=n)return n;S>e&&(e=S)}return e}initializeSearch(t){this.nodes=0,this.ttHits=0,this.ttStores=0,this.startTime=Date.now(),this.timeLimit=t.timeLimit||1/0,this.tt.bumpAge()}shouldStop(){return Date.now()-this.startTime>=this.timeLimit}shouldPruneMove(t,i,e,n,o){return i>=6&&t>=pt.LMP_TABLE[Math.min(i,6)]+o.lmpBonus}shouldReduceMove(t,i,e,n){return i>=3&&t>=4&&!this.isImportantMove(e)}isImportantMove(t){const{row:i,col:e}=t;return(i===0||i===7)&&(e===0||e===7)}filterTacticalMoves(t,i){return t.filter(e=>this.isImportantMove(e)).slice(0,4)}makeMove(t,i,e){const{makeMove:n}=require("../../core"),r=n({board:t,currentPlayer:e,gamePhase:"midgame"},i);return r.success?r.newGameCore.board:t}generateBoardKey(t,i){return`${JSON.stringify(t)}_${i}`}countEmptySquares(t){let i=0;for(let e=0;e<8;e++)for(let n=0;n<8;n++)t[e][n]===null&&i++;return i}evaluateGameEnd(t,i){let e=0,n=0;const o=i==="black"?"white":"black";for(let r=0;r<8;r++)for(let c=0;c<8;c++){const l=t[r][c];l===i?e++:l===o&&n++}return e-n}}const W={level:18,initialWindow:50,maxWindow:400,windowGrowth:2,enableTT:!0,enableKillers:!0,enableHistory:!0};class Et{constructor(){h(this,"pvsEngine");this.pvsEngine=new $t}search(t,i,e=W){let n=R(t,i),o=e.initialWindow,r=1,c=this.pvsEngine.search(t,i,{...e,depthLimit:1});for(c.bestMove&&(n=c.score),r=2;r<=this.getMaxDepth(t,e);r++){const l={...e,depthLimit:r};let a=this.searchWithWindow(t,i,l,n,o);for(;this.isAspirationFailure(a,n,o);)if(o=Math.min(o*e.windowGrowth,e.maxWindow),a=this.searchWithWindow(t,i,l,n,o),o>=e.maxWindow){a=this.pvsEngine.search(t,i,l);break}if(a.bestMove&&(c=a,n=a.score,o=e.initialWindow),e.timeLimit&&c.time>=e.timeLimit*.8)break}return c}searchWithWindow(t,i,e,n,o){return this.pvsEngine.search(t,i,e)}isAspirationFailure(t,i,e){const n=i-e,o=i+e;return t.score<=n||t.score>=o}getMaxDepth(t,i){const e=this.countEmptySquares(t);return i.depthLimit?Math.min(i.depthLimit,e):e<=12?e:e<=20?Math.min(i.level,20):Math.min(i.level,15)}getAdaptiveWindow(t,i){if(t.length<2)return i;let e=0;for(let o=1;o<t.length;o++)e+=Math.abs(t[o]-t[o-1]);const n=e/(t.length-1);return n>100?Math.min(i*2,400):n<30?Math.max(i/2,25):i}multiCutSearch(t,i,e,n){const o=[-2,-1,0,1,2];let r;for(const c of o){const l=n+c,a=this.searchWithWindow(t,i,e,l,e.initialWindow/4);if((!r||a.bestMove&&a.score>r.score)&&(r=a),a.score>n+e.initialWindow)break}return r??this.pvsEngine.search(t,i,e)}countEmptySquares(t){let i=0;for(let e=0;e<8;e++)for(let n=0;n<8;n++)t[e][n]===null&&i++;return i}getLastSearchStats(){return{windowHits:0,windowMisses:0,avgWindow:0}}}class U{constructor(t){h(this,"config");h(this,"moveHistory",[]);h(this,"emergencyMoves",0);this.config=t}allocateTime(t,i,e=!1){const n=this.countEmptySquares(t),o=this.getRemainingTime();if(e&&n<=10)return this.allocateEndgameTime(n,o);const r=this.estimateMovesRemaining(n,i),c=this.calculateBaseAllocation(o,r),l=this.getPhaseMultiplier(n),a=this.getComplexityMultiplier(t),u=this.getHistoryMultiplier(),m=Math.max(this.config.minThinkTime,Math.min(c*l*a*u,this.config.maxThinkTime)),S=Math.min(m*2,o*.25),k=Math.min(m*.3,o*.05);return{targetTime:m,maxTime:S,emergencyTime:k}}allocateEndgameTime(t,i){let e;return t<=4?e=Math.min(i*.4,this.config.maxThinkTime):t<=8?e=Math.min(i*.2,this.config.maxThinkTime*.8):e=Math.min(i*.15,this.config.maxThinkTime*.6),{targetTime:Math.max(e,this.config.minThinkTime),maxTime:Math.min(e*3,i*.5),emergencyTime:this.config.minThinkTime}}estimateMovesRemaining(t,i){return t<=12?Math.max(t-2,1):Math.max(58-i,t/2)}calculateBaseAllocation(t,i){const e=t/Math.max(i,1),n=this.config.increment*.8;return e+n}getPhaseMultiplier(t){return t>=50?.6:t>=30?.8:t>=20?1.2:t>=12?1.4:1}getComplexityMultiplier(t){const i=this.estimateMobility(t),e=this.estimateStability(t);let n=1;return i>8?n*=1.2:i<3&&(n*=.8),e<.3&&(n*=1.3),Math.max(.5,Math.min(n,2))}getHistoryMultiplier(){if(this.moveHistory.length<3)return 1;const t=this.moveHistory.slice(-3),i=t.reduce((n,o)=>n+o,0)/t.length,e=(this.config.minThinkTime+this.config.maxThinkTime)/2;return i>e*1.5?.8:i<e*.5?1.2:1}isEmergencyTime(t,i){return t/Math.max(i,1)<this.config.minThinkTime*1.5}recordMoveTime(t){this.moveHistory.push(t),this.moveHistory.length>10&&this.moveHistory.shift(),t<this.config.minThinkTime*1.2?this.emergencyMoves++:this.emergencyMoves=Math.max(0,this.emergencyMoves-1)}shouldExtendTime(t,i,e,n,o){return t>=e?!1:!n&&t<i*1.5||o&&t<i*1.3?!0:(this.emergencyMoves>3,!1)}getRemainingTime(){return this.config.totalTime}countEmptySquares(t){let i=0;for(let e=0;e<8;e++)for(let n=0;n<8;n++)t[e][n]===null&&i++;return i}estimateMobility(t){let i=0;for(let e=0;e<8;e++)for(let n=0;n<8;n++)if(t[e][n]===null){let o=!1;for(let r=-1;r<=1;r++){for(let c=-1;c<=1;c++){const l=e+r,a=n+c;if(l>=0&&l<8&&a>=0&&a<8&&t[l][a]!==null){o=!0;break}}if(o)break}o&&i++}return Math.max(1,Math.min(i,20))}estimateStability(t){let i=0,e=0;for(let n=0;n<8;n++)for(let o=0;o<8;o++)t[n][o]!==null&&(e++,(n===0||n===7)&&(o===0||o===7)?i+=3:(n===0||n===7||o===0||o===7)&&(i+=1));return e>0?i/e:0}getStats(){const t=this.moveHistory.length>0?this.moveHistory.reduce((n,o)=>n+o,0)/this.moveHistory.length:0,i=(this.config.minThinkTime+this.config.maxThinkTime)/2,e=t>0?Math.min(1,i/t):0;return{averageMoveTime:t,emergencyMoves:this.emergencyMoves,timeEfficiency:e}}}const wt={level:18,timeConfig:{totalTime:3e4,increment:1e3,minThinkTime:500,maxThinkTime:1e4},ttSize:2e5,enableOpeningBook:!1,enableEndgameTablebase:!1};class bt{constructor(t={}){h(this,"name","Engine-Neo");h(this,"version","1.0.0");h(this,"author","TypeScript Refactor");h(this,"config");h(this,"aspirationEngine");h(this,"timeManager");h(this,"tt");h(this,"killers");h(this,"history");h(this,"searchStats");this.config={...wt,...t},this.aspirationEngine=new Et,this.tt=new M(this.config.ttSize||2e5),this.killers=new z,this.history=new G;const i={totalTime:3e4,increment:1e3,minThinkTime:500,maxThinkTime:1e4,...this.config.timeConfig};this.timeManager=new U(i),this.searchStats={totalNodes:0,totalSearches:0,avgDepth:0,ttHitRate:0}}async analyze(t){const i=Date.now(),{gameCore:e,timeLimit:n,skill:o}=t;try{const{board:r,currentPlayer:c}=e,l=o?Math.floor(o/10)+10:this.config.level,a=this.countEmptySquares(r),u=vt(r,yt),m=this.timeManager.allocateTime(r,64-a,u),S=n||m.targetTime,k={...W,...this.config.aspirationConfig,level:l,timeLimit:Math.min(S,m.maxTime),enableTT:!0,enableKillers:!0,enableHistory:!0},v=this.aspirationEngine.search(r,c,k),y=Date.now()-i;return this.timeManager.recordMoveTime(y),this.updateStats(v),this.history.ageHistory(.95),{bestMove:v.bestMove||void 0,evaluation:v.score,depth:v.depth,nodes:v.nodes,timeUsed:y,pv:v.pv||[],stats:{ttHits:v.ttHits,ttStores:v.ttStores,empties:a,isEndgame:u}}}catch(r){console.error("Engine-Neo search error:",r);const c=await this.getFallbackMove(e.board,e.currentPlayer),l=Date.now()-i;return{bestMove:c||void 0,evaluation:0,depth:1,nodes:0,timeUsed:l,pv:[],stats:{error:r instanceof Error?r.message:"Unknown error"}}}}async getFallbackMove(t,i){const{getValidMoves:e}=await Promise.resolve().then(()=>Vt),n=e(t,i);if(n.length===0)return null;const o=n.filter(c=>(c.row===0||c.row===7)&&(c.col===0||c.col===7));if(o.length>0)return o[0];const r=n.filter(c=>c.row===0||c.row===7||c.col===0||c.col===7);return r.length>0?r[0]:n[0]}updateStats(t){this.searchStats.totalNodes+=t.nodes||0,this.searchStats.totalSearches++,t.depth&&(this.searchStats.avgDepth=(this.searchStats.avgDepth*(this.searchStats.totalSearches-1)+t.depth)/this.searchStats.totalSearches),this.searchStats.ttHitRate=.85}formatEvaluation(t,i,e){var o;const n=[];if(n.push(`Score: ${t.score}`),n.push(`Depth: ${t.depth}`),n.push(`Nodes: ${((o=t.nodes)==null?void 0:o.toLocaleString())||0}`),t.time){const r=t.nodes?Math.round(t.nodes/(t.time/1e3)):0;n.push(`NPS: ${r.toLocaleString()}`)}if(e&&n.push(`Endgame (${i} empty)`),t.ttHits&&t.ttStores){const r=Math.round(t.ttHits/(t.ttHits+t.ttStores)*100);n.push(`TT: ${r}%`)}return n.join(" | ")}updateConfig(t){if(this.config={...this.config,...t},t.timeConfig){const i={totalTime:3e4,increment:1e3,minThinkTime:500,maxThinkTime:1e4,...this.config.timeConfig};this.timeManager=new U(i)}t.ttSize&&t.ttSize!==this.config.ttSize&&(this.tt=new M(t.ttSize))}clearState(){this.tt.clear(),this.killers.clear(),this.history.clear(),this.searchStats={totalNodes:0,totalSearches:0,avgDepth:0,ttHitRate:0}}getStats(){return{...this.searchStats,timeStats:this.timeManager.getStats(),ttStats:this.tt.getStats()}}getName(){return"Engine-Neo v1.0"}getFeatures(){return["Principal Variation Search","Aspiration Windows","Transposition Table","Move Ordering (Killers + History)","Dynamic Time Management","Multi-phase Evaluation","Configurable Difficulty","Endgame Solver"]}countEmptySquares(t){let i=0;for(let e=0;e<8;e++)for(let n=0;n<8;n++)t[e][n]===null&&i++;return i}}const kt=new bt,Vt=Object.freeze(Object.defineProperty({__proto__:null,ALL_ONES:B,FILE_A:$,FILE_H:V,NOT_FILE_A:O,NOT_FILE_H:P,bitIndex:it,bitIndexToRC:st,ensureBoard:D,getValidMoves:C,getValidMovesBitboard:lt,getValidMovesMask:ct,maskToRCList:ot,rcToBitIndex:nt,shiftEast:Y,shiftNorth:X,shiftNorthEast:Z,shiftNorthWest:Q,shiftSouth:J,shiftSouthEast:tt,shiftSouthWest:et,shiftWest:j},Symbol.toStringTag,{value:"Module"}));f.AspirationEngine=Et,f.DEFAULT_ASPIRATION_CONFIG=W,f.DEFAULT_ENGINE_CONFIG=wt,f.DifficultyLevel=Tt,f.ENDGAME_THRESHOLD=yt,f.EngineNeo=bt,f.HistoryTable=G,f.KillerMoves=z,f.PRUNING_PARAMS=pt,f.STABILITY_THRESHOLDS=qt,f.TimeManager=U,f.TranspositionTable=M,f.default=kt,f.engineNeo=kt,f.evaluateBoard=R,f.getDifficultyLevel=Kt,f.getLevelConfig=dt,f.getSelectivitySettings=St,f.isEndgamePhase=vt,f.quickEvaluate=Ut,Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
