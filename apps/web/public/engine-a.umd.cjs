(function(u,l){typeof exports=="object"&&typeof module<"u"?l(exports):typeof define=="function"&&define.amd?define(["exports"],l):(u=typeof globalThis<"u"?globalThis:u||self,l(u.EngineA={}))})(this,function(u){"use strict";var we=Object.defineProperty;var Ge=(u,l,p)=>l in u?we(u,l,{enumerable:!0,configurable:!0,writable:!0,value:p}):u[l]=p;var f=(u,l,p)=>Ge(u,typeof l!="symbol"?l+"":l,p);const l=0x0101010101010101n,p=0x8080808080808080n,v=0xffffffffffffffffn,P=v^l,B=v^p;function H(r){return(r&B)<<1n}function E(r){return(r&P)>>1n}function x(r){return r<<8n}function T(r){return r>>8n}function R(r){return(r&B)<<9n}function A(r){return(r&P)<<7n}function I(r){return(r&B)>>7n}function C(r){return(r&P)>>9n}const te=[H,E,x,T,R,A,I,C];function re(r){let e=0,t=BigInt(r);for(;t;)e++,t&=t-1n;return e}function O(r){let e=0n,t=BigInt(r);for(;t>1n;)t>>=1n,e++;return Number(e)}function $(r,e){return(7-r)*8+e}function ne(r){if(r<0||r>63)throw new Error("Invalid bit index: "+r);const t=7-(r/8|0),s=r%8;return[t,s]}function W(r,e){return 1n<<BigInt($(r,e))}function se(r){const e=[];let t=BigInt(r);for(;t;){const s=t&-t,n=O(s),[o,i]=ne(n);e.push({row:o,col:i}),t^=s}return e}function F(r){return r&&typeof r.length=="number"&&typeof r.subarray=="function"}function oe(r){const e=new Uint8Array(64);for(let t=0;t<8;t++)for(let s=0;s<8;s++){const n=r[t][s];e[t*8+s]=n==="black"?1:n==="white"?2:0}return e}function ie(r){let e=0n,t=0n;for(let s=0;s<64;s++){const n=r[s]|0;if(n===0)continue;const o=s/8|0,i=s%8,a=$(o,i),c=1n<<BigInt(a);n===1?e|=c:n===2&&(t|=c)}return{bp:e,wp:t}}function h(r){let e;if(F(r)?e=r:Array.isArray(r)&&Array.isArray(r[0])?e=oe(r):Array.isArray(r)?e=Uint8Array.from(r):r&&r.cells&&F(r.cells)?e=r.cells:e=new Uint8Array(64),e._bp===void 0||e._wp===void 0){const{bp:t,wp:s}=ie(e);e._bp=t,e._wp=s}return e}function ae(r,e,t){let s=t(r)&e;return s|=t(s)&e,s|=t(s)&e,s|=t(s)&e,s|=t(s)&e,s|=t(s)&e,t(s)}function ce(r,e){const t=h(e),s=r===1?t._bp:t._wp,n=r===1?t._wp:t._bp,o=~(s|n)&v;let i=0n;for(const a of te)i|=ae(s,n,a);return i&o}function M(r){return r==="black"?1:2}function ue(r,e){const t=M(r),s=ce(t,e);return se(s)}function j(r,e,t){let s=0n,n,o;for(n=H(t),o=0n;n&&n&e;)o|=n,n=H(n);for(n&r&&(s|=o),n=E(t),o=0n;n&&n&e;)o|=n,n=E(n);for(n&r&&(s|=o),n=x(t),o=0n;n&&n&e;)o|=n,n=x(n);for(n&r&&(s|=o),n=T(t),o=0n;n&&n&e;)o|=n,n=T(n);for(n&r&&(s|=o),n=R(t),o=0n;n&&n&e;)o|=n,n=R(n);for(n&r&&(s|=o),n=A(t),o=0n;n&&n&e;)o|=n,n=A(n);for(n&r&&(s|=o),n=I(t),o=0n;n&&n&e;)o|=n,n=I(n);for(n&r&&(s|=o),n=C(t),o=0n;n&&n&e;)o|=n,n=C(n);return n&r&&(s|=o),s}function J(r,e,t,s){const n=M(t),o=h(s),i=W(r,e),a=n===1?o._bp:o._wp,c=n===1?o._wp:o._bp;return(i&(a|c))!==0n?!1:j(a,c,i)!==0n}function U(r,e,t,s){const n=M(s),o=h(r),i=W(e,t),a=n===1?o._bp:o._wp,c=n===1?o._wp:o._bp;if((i&(a|c))!==0n)return;const m=j(a,c,i);if(!m)return;const b=o._bp,w=o._wp,G=a|i|m,k=c&~m;n===1?(o._bp=G,o._wp=k):(o._wp=G,o._bp=k);let d=m|i;for(;d;){const ee=d&-d,be=O(ee);o[be]=n,d^=ee}return{__native:!0,side:n,row:e,col:t,moveMask:i,flips:m,prevBP:b,prevWP:w}}function le(r,e,t){const s=h(r);if(!e||!e.__native)return;s._bp=e.prevBP,s._wp=e.prevWP;let o=e.flips|e.moveMask;for(;o;){const i=o&-o,a=O(i),c=1n<<BigInt(a),m=(e.prevBP&c)!==0n,b=(e.prevWP&c)!==0n;s[a]=m?1:b?2:0,o^=i}}function he(r){const e=h(r),t=e._bp|e._wp;return re(~t&v)}function fe(r,e){const t=M(e),s=h(r),n=0x100000001b3n,o=0x100000001b5n;let i=0xcbf29ce484222325n;return i^=s._bp*n&v,i*=o,i^=s._wp*o&v,i*=n,i^=BigInt(t&3),i*=0x100000001b7n,Number(i&0xffffffffffffffffn)}function y(r){const e=new Uint8Array(64);for(let t=0;t<8;t++)for(let s=0;s<8;s++){const n=r[t][s],o=t*8+s;n==="black"?e[o]=1:n==="white"?e[o]=2:e[o]=0}return e}function N(r){const e=[];for(let t=0;t<8;t++){const s=[];for(let n=0;n<8;n++){const o=t*8+n,i=r[o];i===1?s.push("black"):i===2?s.push("white"):s.push(null)}e.push(s)}return e}function D(r=crypto.randomUUID()){const e=Array.from({length:8},()=>new Array(8).fill(null));e[3][3]="white",e[3][4]="black",e[4][3]="black",e[4][4]="white";const t=_(e,"black");return{id:r,board:e,currentPlayer:"black",validMoves:t,score:{black:2,white:2},status:"playing",moveHistory:[],canUndo:!1,canRedo:!1}}function _(r,e){const t=h(y(r));return ue(e,t)}function q(r,e,t){const s=h(y(r));return J(e.row,e.col,t,s)}function V(r,e){if(r.status!=="playing")return{success:!1,reason:"game_finished",message:"Game is not in playing state"};if(!(r.currentPlayer==="black"||r.currentPlayer==="white"))return{success:!1,reason:"not_your_turn",message:"Invalid current player"};const t=h(y(r.board));if(!J(e.row,e.col,r.currentPlayer,t))return t[e.row*8+e.col]!==0?{success:!1,reason:"occupied",message:"Position is already occupied"}:{success:!1,reason:"no_captures",message:"Move would not capture any pieces"};if(!U(t,e.row,e.col,r.currentPlayer))return{success:!1,reason:"invalid_position",message:"Failed to apply move"};const n=N(t),o=[];for(let g=0;g<8;g++)for(let d=0;d<8;d++)r.board[g][d]!==n[g][d]&&!(g===e.row&&d===e.col)&&o.push({row:g,col:d});const i={row:e.row,col:e.col,player:r.currentPlayer,capturedCells:o,timestamp:Date.now()},a=S(n),c=r.currentPlayer==="black"?"white":"black",m=_(n,c);let b=c,w=m,G="playing";if(m.length===0){const g=_(n,r.currentPlayer);g.length===0?(G="finished",w=[]):(b=r.currentPlayer,w=g)}const k={...r,board:n,currentPlayer:b,validMoves:w,score:a,status:G,moveHistory:[...r.moveHistory,i],canUndo:!0,canRedo:!1};return{success:!0,move:i,newGameCore:k,capturedCells:o}}function S(r){let e=0,t=0;for(let s=0;s<8;s++)for(let n=0;n<8;n++){const o=r[s][n];o==="black"?e++:o==="white"&&t++}return{black:e,white:t}}function L(r){if(r.status==="finished")return!0;if(_(r.board,r.currentPlayer).length>0)return!1;const t=r.currentPlayer==="black"?"white":"black";return _(r.board,t).length===0}function X(r){if(!L(r))return null;const e=S(r.board);let t;return e.black>e.white?t="black":e.white>e.black?t="white":t="draw",{winner:t,score:e,endReason:"normal",duration:0,totalMoves:r.moveHistory.length}}function Z(r){const e=h(y(r.board));return fe(e,r.currentPlayer)}function me(r,e){return _(r,e).length}function de(r){const e=h(y(r));return he(e)}class ge{constructor(e={}){f(this,"_currentGame");f(this,"_gameHistory",[]);f(this,"_redoStack",[]);f(this,"_listeners",[]);f(this,"_config");this._config={maxHistorySize:e.maxHistorySize||100,enableUndo:e.enableUndo??!0,enableRedo:e.enableRedo??!0,autoSave:e.autoSave??!1},this._currentGame=D(),this._gameHistory.push({...this._currentGame}),this.emit({type:"game_started",gameCore:this._currentGame})}get currentGame(){return this._currentGame}get currentPlayer(){return this._currentGame.currentPlayer}get validMoves(){return this._currentGame.validMoves}get score(){return this._currentGame.score}get isGameOver(){return L(this._currentGame)}get gameResult(){return X(this._currentGame)}get canUndo(){return this._config.enableUndo&&this._gameHistory.length>1}get canRedo(){return this._config.enableRedo&&this._redoStack.length>0}makeMove(e){if(this.isGameOver)return{success:!1,reason:"game_finished",message:"Game is already finished"};const t=V(this._currentGame,e);if(t.success){if(this._currentGame=t.newGameCore,this._redoStack=[],this._gameHistory.push({...this._currentGame}),this._gameHistory.length>this._config.maxHistorySize&&this._gameHistory.shift(),this.emit({type:"move_made",move:t.move,gameCore:this._currentGame}),this.isGameOver){const s=this.gameResult;s&&this.emit({type:"game_over",result:s})}else this.emit({type:"turn_changed",player:this._currentGame.currentPlayer});this._config.autoSave&&this.saveToStorage()}return t}undo(){if(!this.canUndo)return!1;this._redoStack.push({...this._currentGame}),this._gameHistory.pop();const e=this._gameHistory[this._gameHistory.length-1];return this._currentGame={...e},this.emit({type:"move_undone",gameCore:this._currentGame}),this.emit({type:"turn_changed",player:this._currentGame.currentPlayer}),!0}redo(){if(!this.canRedo)return!1;const e=this._redoStack.pop();return this._currentGame=e,this._gameHistory.push({...this._currentGame}),this.emit({type:"move_redone",gameCore:this._currentGame}),this.emit({type:"turn_changed",player:this._currentGame.currentPlayer}),!0}reset(){this._currentGame=D(),this._gameHistory=[{...this._currentGame}],this._redoStack=[],this.emit({type:"game_reset",gameCore:this._currentGame}),this.emit({type:"game_started",gameCore:this._currentGame})}isValidMove(e){return q(this._currentGame.board,e,this._currentGame.currentPlayer)}getValidMoves(){return _(this._currentGame.board,this._currentGame.currentPlayer)}setGameStatus(e){this._currentGame.status!==e&&(this._currentGame={...this._currentGame,status:e})}getPositionHash(){return Z(this._currentGame)}getMoveHistory(){return this._currentGame.moveHistory}getGameStats(){return{totalMoves:this._currentGame.moveHistory.length,score:this._currentGame.score,gameId:this._currentGame.id,currentPlayer:this._currentGame.currentPlayer,status:this._currentGame.status,canUndo:this.canUndo,canRedo:this.canRedo,validMovesCount:this._currentGame.validMoves.length,historySize:this._gameHistory.length}}addEventListener(e){this._listeners.push(e)}removeEventListener(e){const t=this._listeners.indexOf(e);t!==-1&&this._listeners.splice(t,1)}removeAllEventListeners(){this._listeners=[]}emit(e){this._listeners.forEach(t=>{try{t(e)}catch(s){console.error("Error in game event listener:",s)}})}saveToStorage(e="othello-game-state"){try{const t={currentGame:this._currentGame,gameHistory:this._gameHistory,redoStack:this._redoStack,timestamp:Date.now()};localStorage.setItem(e,JSON.stringify(t))}catch(t){console.error("Failed to save game state:",t)}}loadFromStorage(e="othello-game-state"){try{const t=localStorage.getItem(e);if(!t)return!1;const s=JSON.parse(t);return this._currentGame=s.currentGame,this._gameHistory=s.gameHistory||[],this._redoStack=s.redoStack||[],this.emit({type:"game_started",gameCore:this._currentGame}),!0}catch(t){return console.error("Failed to load game state:",t),!1}}exportGame(){const e=this._currentGame.moveHistory.map((n,o)=>{const i=Math.floor(o/2)+1,a=n.player==="black"?"B":"W",c=`${String.fromCharCode(97+n.col)}${n.row+1}`;return`${i}.${a} ${c}`}),t=this.gameResult,s=t?t.winner==="draw"?"1/2-1/2":t.winner==="black"?"1-0":"0-1":"*";return[`[Game "${this._currentGame.id}"]`,'[Black "Player"]','[White "Player"]',`[Result "${s}"]`,`[Score "${this._currentGame.score.black}-${this._currentGame.score.white}"]`,"",e.join(" ")+(s!=="*"?` ${s}`:"")].join(`
`)}createSimulation(){return JSON.parse(JSON.stringify(this._currentGame))}simulateMoves(e){let t=this.createSimulation();for(const s of e){const n=V(t,s);if(n.success)t=n.newGameCore;else break}return t}getGameStateAtMove(e){return e<0||e>=this._gameHistory.length?null:{...this._gameHistory[e]}}dispose(){this.removeAllEventListeners(),this._gameHistory=[],this._redoStack=[]}}class _e{constructor(){f(this,"gameCore");f(this,"gameStateManager");f(this,"bitboard",null);this.gameCore=D(),this.gameStateManager=new ge}getValidMoves(e,t){return _(e,t)}isValidMove(e,t,s){return q(e,t,s)}simulateMove(e,t,s){try{const n=h(y(e));return U(n,t.row,t.col,s)?N(n):null}catch(n){return console.warn("SimulateMove error:",n),null}}applyMove(e,t){return V(e,t)}calculateScore(e){return S(e)}getEmptySquares(e){return de(e)}getMobility(e,t){return me(e,t)}isGameOver(e){return L(e)}getGameResult(e){return X(e)}getPositionHash(e){return Z(e)}boardToBitBoard(e){return h(y(e))}bitBoardToBoard(e){return N(e)}flipPiecesBitboard(e,t,s,n){return U(e,t,s,n)}undoMoveBitboard(e,t){le(e,t)}getStoneDifference(e,t="black"){return K(e,t)}mapEvaluationToStoneScale(e){return Q(e)}summarizeEvaluation(e,t,s="black"){return ye(e,t,s)}getGameStateManager(){return this.gameStateManager}getCurrentGameCore(){return this.gameCore}updateGameCore(e){this.gameCore=e}getOpponent(e){return e==="black"?"white":"black"}copyBoard(e){return e.map(t=>[...t])}analyzeGamePhase(e){const t=this.getEmptySquares(e);return t>50?"opening":t>20?"midgame":"endgame"}difficultyToSkill(e){return{easy:25,medium:50,hard:75,expert:90,master:100}[e]||50}skillToDifficulty(e){return e<=30?"easy":e<=60?"medium":e<=80?"hard":e<=95?"expert":"master"}initialize(){}cleanup(){}updateConfig(e){}getFallbackResponse(e){const t=this.getValidMoves(this.gameCore.board,this.gameCore.currentPlayer);return{bestMove:t.length>0?t[Math.floor(Math.random()*t.length)]:void 0,evaluation:0,depth:0,nodes:1,timeUsed:Date.now()-e}}validateRequest(e){if(!e.gameCore)throw new Error("GameCore is required");if(!e.gameCore.board)throw new Error("Board is required");if(!e.gameCore.currentPlayer)throw new Error("Current player is required")}}const z=64;function K(r,e="black"){const{black:t,white:s}=S(r);return e==="black"?t-s:s-t}function Q(r){if(r===void 0||Number.isNaN(r))return 0;const e=Math.tanh(r/120),t=Math.round(e*z);return Math.max(-z,Math.min(z,t))}function ye(r,e,t="black"){return{perspective:t,stoneDiff:K(r,t),normalizedEval:Q(e)}}function pe(r){if(r.length)return r[Math.floor(Math.random()*r.length)]}class Y extends _e{constructor(){super(...arguments);f(this,"name","Random Engine");f(this,"version","1.0.0");f(this,"author","Infinite Othello")}async analyze(t){const s=Date.now();try{this.validateRequest(t);const n=this.getValidMoves(t.gameCore.board,t.gameCore.currentPlayer),o=pe(n);return this.updateGameCore(t.gameCore),{bestMove:o,evaluation:0,nodes:n.length,depth:1,timeUsed:Date.now()-s,pv:o?[o]:void 0}}catch(n){return console.error("Engine-A error:",n),this.getFallbackResponse(s)}}}const ve=new Y;u.EngineA=Y,u.default=ve,Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
